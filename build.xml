<!DOCTYPE project [
      <!ENTITY propertiesAndPaths SYSTEM "propertiesAndPaths.xmli">
      <!ENTITY compile SYSTEM "compile.xmli">
    ]>  
    
<project name="ejbca" default="build" basedir=".">

	<!-- Import build specific info, like version number -->
    <property file="src/internal.properties" />
	
	<dirname property="ejbca.home" file="${ant.file.ejbca}"/>
    <property environment="env" />
	
    <!-- set global properties for this build -->
    <property name="tmp" value="${ejbca.home}/tmp" />
    <property name="lib" value="${ejbca.home}/lib" />
    
    <property name="dist.dir" location="${ejbca.home}/dist" />
    <property name="ocsp-dist.dir" location="${ejbca.home}/ocsp-dist" />
	
    <property name="hwtoken_classes" value="hwtoken"/>
    <property name="hwtoken.class.dir" location="${hwtoken_classes}" />
    <property name="apidoc" value="${ejbca.home}/doc/api" />

    <property name="doc.src" value="${tmp}/htdocs" />
	
	<!-- include the standard properties and paths -->
    <import file="propertyDefaults.xml"/>

	<import file="bin/${appserver.type}.xml" />
	<import file="./test.xmli" />
	<import file="./docs.xmli" />
	
    <!-- =================================================================== -->
    <!-- Clover stuff                                                        -->
    <!-- =================================================================== -->
	<taskdef resource="cloverlib.xml" classpath="/home/hudson/clover/clover-ant-2.5.0/lib/clover.jar"/>
		
	<target name="guard.noclover" unless="clover.installed">
		<available property="clover.installed" classname="com.cenqua.clover.CloverInstr"/>
		<fail unless="clover.installed" message="The target you are attempting to run requires Clover, which doesn't appear to be installed"/>
	</target>
	
	<target name="with.clover">
		<clover-setup>
			<fileset dir="${ejbca.home}/src/java">
				<exclude name="org/apache/**/*.java"/>
				<exclude name="com/novosec/**/*.java"/>
			</fileset>
		</clover-setup>
	</target>

	<target name="clover.xml">
	    <clover-report>
	       <current outfile="coverage.xml">
	          <format type="xml"/>
	       </current>
	    </clover-report>
	 </target>
	
	<target name="clover.html">
		<clover-html-report outdir="clover_html" title="EJBCA"/>
	 </target>

    <!-- =================================================================== -->
    <!-- Clean ALL                                                           -->
    <!-- =================================================================== -->
    <target name="clean">
        <delete dir="${dist.dir}" />
        <delete dir="${ocsp-dist.dir}" />
        <delete dir="${apidoc}" />
        <delete dir="${tmp}"/>
        <delete file="velocity.log" />
        <ant antfile="modules/build.xml" target="clean" inheritall="false"/>
    </target>
	
    <!-- =================================================================== -->
    <!-- Build ALL                                                           -->
    <!-- =================================================================== -->
    <target name="build" depends="testforgnujava, ejbca.ear, ejbca.clients" description="Builds EJBCA"/>

	<!--
	  EJBCA need to be run before the app.server (or the webapp) is fully ssl configured with the keystore
	  So we are 'bootstrapping' it, the 'j2ee.web-noconfigure' property will skip all the serverside
	  -->
    <target name="bootstrap" depends="testforgnujava" description="Bootstrap EJBCA application">
        <ant target="deploy">
        	<reference refid="clover.files"/>
        	<reference refid="clover.useclass.files"/>
        	<property name="j2ee.web-noconfigure" value="true"/>
        </ant>
    </target>

	<!--
	  Installs EJBCA by creating an initial CA, configuring the web container and generating certs for
	  SSL and the super administrator.
	  -->
    <target name="install" depends="ejbca-ejb-cli" description="Install EJBCA application (only once)">
        <ant dir="${ejbca.home}/bin" antfile="cli.xml" target="ejbca:install" />
    </target>
	
    <target name="javatruststore" depends="testforgnujava" description="Install RootCA ceritficate in Java trust store (can be run wih -Dca.name=FooCA -Dtrust.keystore=trust.jks -Dtrust.password=foo123)">
        <ant dir="${ejbca.home}/bin" antfile="cli.xml" target="ejbca:javatruststore" />
        <antcall target="j2ee:deploytruststore" />
    </target>

    <!-- =================================================================== -->
    <!-- Compile ocsp resonder java sources                                  -->
    <!-- =================================================================== -->
    <target name="ocsp-compile" depends="ejbca-util.jar, ocsp-entity, ocsp-ejb-interface">
    	<echo message="THIS TARGET (ocsp-compile) SHOULD NO LONGER BE USED!"/>
    </target>

    <!-- =================================================================== -->
	<!-- Make sure the user isn't using the GNU version of java              -->
    <!-- =================================================================== -->
	<target name="testforgnujava">
		<exec executable="java" outputproperty="testforgnujava.temp">
			<arg value="-version" />
		</exec>

		<fail>
			<condition>
				<contains string="${testforgnujava.temp}" substring="gij" />
			</condition>
			..
			You are currently using the GNU version of JAVA. Please install the version from Sun
			or make sure that the Sun version of java is in the path. If this was run using 'sudo'
			or 'su', make sure that the superuser has the correct path too.
		</fail>
	</target>
	
    <!-- =================================================================== -->
	<!-- Dont allow deploy of the wrong thing in production                   -->
    <!-- =================================================================== -->
    <target name="failinproduction-ca">
		<fail message="You cannot deploy EJBCA as a CA reponder in a OCSP production environment.">
			<condition>
				<equals arg1="${ejbca.productionmode}" arg2="ocsp" casesensitive="false"/>
			</condition>
		</fail>
    </target>

    <target name="failinproduction-ocsp">
		<fail message="You cannot deploy EJBCA as a OCSP Responder in a CA production environment.">
			<condition>
				<equals arg1="${ejbca.productionmode}" arg2="ca" casesensitive="false"/>
			</condition>
		</fail>
    </target>

    <!-- =================================================================== -->
    <!-- Build doc part                                                                                                                             -->
    <!-- =================================================================== -->
    <target name="doc.war" if="doc.war.enabled">
    	<antcall target="doc" />
		<war destfile="${dist.dir}/doc.war" webxml="${ejbca.home}/src/publicweb/empty_webxml.xml">
            <fileset dir="${doc.src}" />
        </war>
    </target>
	
    <!-- =================================================================== -->
    <!-- Build ca ejb part                                                    -->
    <!-- =================================================================== -->
    <target name="ejbca-ejb.jar">
    	<ant antfile="build.xml" dir="modules" target="ejbca-ejb" />
    </target>
	
    <!-- =================================================================== -->
    <!-- Build ejbca util part                                                    -->
    <!-- =================================================================== -->
    <target name="ejbca-util.jar" description="Creates ejbca util classes for use in other projects.jar">
        <ant antfile="build.xml" dir="modules" target="ejbca-util" />
    </target>    	

    <!-- =================================================================== -->
    <!-- Build ocsp ejb part                                                    -->
    <!-- =================================================================== -->
    <target name="ocsp-jar">
    	<ant antfile="build.xml" dir="modules" target="ocsp-ejb" />
    </target>

    <!-- =================================================================== -->
    <!-- Build CA-ear                                                        -->
    <!-- =================================================================== -->
	<target name="ejbca.ear" depends="display-properties, ejbca.ear.module-dependencies, doc.war, create-log4config-bundle">
	    <property name="caear" value="${dist.dir}/ejbca.ear" />
		<property name="eardd.src" value="${tmp}/ear" />
		<!-- Make sure we have an application.xml since we want to specify base URLs. Configure enabled modules. -->
		<condition property="doc.war.enabled.replace-string" else="!--@doc.war@-->" value="module>&lt;web>&lt;web-uri>doc.war&lt;/web-uri>&lt;context-root>/ejbca/doc&lt;/context-root>&lt;/web>&lt;/module>">
			<istrue value="${doc.war.enabled}"/>
		</condition>
		<condition property="ejbcaws.enabled.replace-string" else="!--@ejbca-ws-ejb.jar@-->" value="module>&lt;ejb>ejbca-ws-ejb.jar&lt;/ejb>&lt;/module>">
			<istrue value="${ejbcaws.enabled}"/>
		</condition>
		<condition property="xkms.enabled.replace-string" else="!--@ejbca-xkms-ejb.jar@-->" value="module>&lt;ejb>ejbca-xkms-ejb.jar&lt;/ejb>&lt;/module>">
			<istrue value="${xkms.enabled}"/>
		</condition>
		<condition property="renew.enabled.replace-string" else="!--@renew.war@-->" value="module>&lt;web>&lt;web-uri>renew.war&lt;/web-uri>&lt;context-root>/ejbca/renew&lt;/context-root>&lt;/web>&lt;/module>">
			<istrue value="${web.renewalenabled}"/>
		</condition>
		<condition property="ejbca-cmp-tcp.enabled.replace-string" else="!--@ejbca-cmp-tcp.war@-->" value="module>&lt;web>&lt;web-uri>ejbca-cmp-tcp.war&lt;/web-uri>&lt;context-root>/ejbca/cmp-tcp&lt;/context-root>&lt;/web>&lt;/module>">
			<istrue value="${cmp.tcp.enabled}"/>
		</condition>
		<mkdir dir="${eardd.src}/META-INF"/>
		<copy todir="${eardd.src}/META-INF" file="src/deploy/ear/META-INF/application.xml" flatten="true" failonerror="true">
			<filterchain>
				<replacestring from="!--@doc.war@-->" to="${doc.war.enabled.replace-string}"/>
				<replacestring from="!--@ejbca-ws-ejb.jar@-->" to="${ejbcaws.enabled.replace-string}"/>
				<replacestring from="!--@ejbca-xkms-ejb.jar@-->" to="${xkms.enabled.replace-string}"/>
				<replacestring from="!--@renew.war@-->" to="${renew.enabled.replace-string}"/>
				<replacestring from="!--@ejbca-cmp-tcp.war@-->" to="${ejbca-cmp-tcp.enabled.replace-string}"/>
			</filterchain>
		</copy>
		<!-- This dir has to exist here -->
		<mkdir dir="${hwtoken.class.dir}"/>
		<!-- Include Hibernate JPA libraries if they don't exist in the current application server. -->
		<condition property="bundle-hibernate-exclude" value="" else="**">
			<isset property="bundle-hibernate-jpa"/>
		</condition>
		<!-- Build the EAR -->
        <ear destfile="${caear}" appxml="${eardd.src}/META-INF/application.xml">
    		<!-- Specify that we will use a specific WS implementation -->
            <zipfileset prefix="META-INF/services" dir="${ejbca.home}/src/deploy/ear/META-INF/services/" includes="javax.xml.soap.MetaFactory"/>
            <zipfileset prefix="lib" dir="${lib}">
                <include name="bcmail-jdk${java.ver}-145.jar" />
                <include name="bcprov-jdk${java.ver}-145.jar" />
                <include name="bctsp-jdk${java.ver}-145.jar" />
                <include name="cert-cvc.jar" />
                <include name="log4j-1.2.16.jar" />
                <include name="ldap.jar" />
                <include name="commons-*.jar" />
                <include name="libidn.jar" />	<!-- XKMS -->
            </zipfileset>
            <zipfileset prefix="lib" dir="${lib}/batik" includes="*.jar"/>
            <zipfileset prefix="lib" dir="${lib}/xmlsign" includes="xmlsec-1.4.3.jar xalan-2.7.1.jar serializer-2.7.1.jar"/>	<!-- XKMS -->
            <fileset dir="${dist.dir}" includes="doc.war"/>
            <fileset dir="${ejbca.home}/modules/dist">
                <include name="ejbca-ejb.jar" />
                <include name="ejbca-ws-ejb.jar" />
                <include name="ejbca-xkms-ejb.jar" />
                <include name="adminweb.war" />
                <include name="cmp.war" />
                <include name="publicweb.war" />
                <include name="scep.war" />
                <include name="healthcheck.war" />
                <include name="clearcache.war" />
                <include name="webdist.war" />
                <include name="ocsp.war" />
                <include name="renew.war" />
                <include name="ejbca-cmp-tcp.war" />
            </fileset>
        	<zipfileset prefix="lib" dir="${ejbca.home}/modules/dist">
                <include name="externalra-service.jar" />
                <include name="ejbca-ejb3-interface.jar" />
                <include name="ejbca-entity.jar" />
                <include name="log4jconfig.jar" />
        	</zipfileset>
        	<zipfileset prefix="lib" dir="${lib}/hibernate" excludes="${bundle-hibernate-exclude}"/>
        	<zipfileset prefix="lib" dir="${dist.dir}" includes="ejbca-util.jar"/>
        	<!-- Include PrimeCard HSM libraries. TODO: Test that this works. Previously the classes were included in ejbca-ejb.jar.. -->
        	<zipfileset prefix="lib" dir="${hwtoken.class.dir}" includes="*.jar"/>
		</ear>
    	<antcall target="signjar">
        	<param name="signjar.file" value="${caear}"/>
    	</antcall>
    </target>

	<target name="create-log4config-bundle">
		<mkdir dir="tmp"/>
		<!-- For appservers that don't come with Log4J we need to bundle a configuration file in the classpath (in the EARs lib/ directory in a JAR) -->
		<copy file="conf/log4j-${appserver.type}.xml" tofile="tmp/log4j.xml" failonerror="false"/>
		<jar destfile="modules/dist/log4jconfig.jar" whenempty="skip" basedir="tmp" includes="log4j.xml"/>
		<delete file="tmp/log4j.xml"/>
	</target>
	
    <!-- =================================================================== -->
    <!-- Build OCSP-ear                                                        -->
    <!-- =================================================================== -->
    <target name="ocsp-ear" depends="display-properties, ocsp-war, ocsp-jar, ocsphealthcheck.war, create-log4config-bundle">
		<!-- Include Hibernate JPA libraries if they don't exist in the current application server. -->
		<condition property="bundle-hibernate-exclude" value="" else="**">
			<isset property="bundle-hibernate-jpa"/>
		</condition>
        <mkdir dir="${ocsp-dist.dir}"/>
        <ear destfile="${ocsp-dist.dir}/ejbca.ear" appxml="${ejbca.home}/src/deploy/ocsp-ear/META-INF/application.xml"> 
            <zipfileset prefix="lib" dir="${lib}">
                <include name="bcmail-jdk${java.ver}-145.jar" />
                <include name="bcprov-jdk${java.ver}-145.jar" />
                <include name="cert-cvc.jar" />
                <include name="log4j-1.2.16.jar" />
                <include name="ldap.jar" />
                <include name="commons-lang-*.jar" />
                <include name="commons-collections-3.2.jar" />
                <include name="commons-fileupload-1.0.jar" />
                <include name="commons-configuration-1.6.jar" />
                <include name="commons-logging-1.1.1.jar" />
            </zipfileset>
        	<zipfileset prefix="lib" dir="${lib}/hibernate" excludes="${bundle-hibernate-exclude}"/>
            <fileset dir="${ejbca.home}/modules/dist">
                <include name="healthcheck.war" />
                <include name="ocsp.war" />
                <include name="ocsp-ejb.jar" />
            </fileset>
        	<zipfileset prefix="lib" dir="${ejbca.home}/modules/dist">
                <include name="ocsp-ejb3-interface.jar" />
                <include name="ocsp-entity.jar" />
                <include name="log4jconfig.jar" />
        	</zipfileset>
        	<zipfileset prefix="lib" dir="${dist.dir}" includes="ejbca-util.jar"/>
	</ear>
    </target>
	
    <!-- =================================================================== -->
    <!-- Build Javadoc part                                                  -->
    <!-- =================================================================== -->
    <target name="javadoc" description="Build JavaDoc for all modules">
        <mkdir dir="${apidoc}" />
    	<path id="javadoc-dependencies.classpath">
    		<fileset dir="${lib}" includes="**/*.jar"/>
    	</path>
    	<!-- extdirs="${lib}" -->
        <javadoc packagenames="org.ejbca.*" maxmemory="256m" destdir="${apidoc}" classpathref="javadoc-dependencies.classpath" 
        	author="true" version="true" use="true" windowtitle="EJBCA API" bottom="Copyright &#169; PrimeKey Solutions AB." >
        	<sourcepath location="${ejbca.home}/src/java"/>
           	<sourcepath location="${ejbca.home}/modules/externalra-scep/src"/>
           	<sourcepath location="${ejbca.home}/modules/externalra/src"/>
           	<sourcepath location="${ejbca.home}/modules/ejbca-xkms/src"/>
           	<sourcepath location="${ejbca.home}/modules/ejbca-ws-cli/src"/>
           	<sourcepath location="${ejbca.home}/modules/ejbca-ws-cli/src-gen"/>
           	<sourcepath location="${ejbca.home}/modules/ejbca-ws/src"/>	<!-- ECA-1396 will probably change this.. -->
           	<sourcepath location="${ejbca.home}/modules/ejbca-ejb-cli/src"/>
           	<sourcepath location="${ejbca.home}/modules/clientToolBox/src"/>
           	<sourcepath location="${ejbca.home}/modules/cmpProxy/src"/>
           	<sourcepath location="${ejbca.home}/modules/ejbca-entity/src"/>
        </javadoc>
    	<echo message=""/>
    	<dirname file="${apidoc}/index.html" property="javadoc.dir"/>
    	<echo message="EJBCA API is available in file://${javadoc.dir}/index.html"/>
    </target>

    <!-- ========================================================================== -->
    <!-- Upgrades the database for a new version of ejbca                           -->
    <!-- ========================================================================== -->
    <target name="base-upgrade" depends="ejbca-ejb-cli">
        <!-- Get input -->
        <input message="Which version of EJBCA are you upgrading from:" addproperty="ejbca.upgradefromversion"
        	validargs="3.11.x"/> 
        <java dir="${ejbca.home}" jar="${ejbca.home}/dist/ejbca-ejb-cli/ejbca-ejb-cli.jar" fork="true">
            <arg line="upgrade ${database.name} ${ejbca.upgradefromversion} ${upgrade.post}"/>
        </java>
    </target>
    <target name="set-upgrade">
        <property name="upgrade.post" value=""/>
    </target>
    <target name="set-post-upgrade">
        <property name="upgrade.post" value="*"/>
    </target>
    <target name="upgrade" depends="set-upgrade,base-upgrade"/>
    <target name="post-upgrade" depends="set-post-upgrade,base-upgrade"/>

    <!-- ======================================================================= -->
    <!-- Promts for password properties if not previously set.                   -->
	<!-- Note: This code is duplicated in cli.xml								 -->
	<!-- Ask the following only at deploy, not at bootstrap						 -->
    <!-- ======================================================================= -->
	<target name="inputBootstrapAndDeployPasswords" >
		<input message="Please enter the password to the database. A blank password works for hsqldb." addproperty="database.password" defaultvalue="">
			<handler classname="org.apache.tools.ant.input.SecureInputHandler" />
		</input>
	</target>
	
	
    <!-- ======================================================================= -->
    <!-- Promts for password properties if not previously set.                   -->
	<!-- Note: This code is duplicated in cli.xml								 -->
	<!-- Ask the following only at deploy, not at bootstrap						 -->
    <!-- ======================================================================= -->
	<target name="inputDeployPasswords" unless="j2ee.web-noconfigure">
		<input message="Please enter the password of the truststore with the CA certificate for https?" addproperty="java.trustpassword" defaultvalue="changeit">
			<handler classname="org.apache.tools.ant.input.SecureInputHandler" />
		</input>
		<input message="Please enter the password of the keystore with the TLS key for https" addproperty="httpsserver.password" defaultvalue="serverpwd">
			<handler classname="org.apache.tools.ant.input.SecureInputHandler" />
		</input>
	</target>
	
    <!-- ======================================================================= -->
    <!-- Deploy EJBCA ear to JBoss                                               -->
    <!-- ======================================================================= -->
    <target name="deploy" depends="failinproduction-ca,build, inputDeployPasswords,inputBootstrapAndDeployPasswords" description="Deploy the main EJBCA application">
    	<antcall target="j2ee:deploy" />
        <antcall target="showtime" />
    </target>
    <target name="ocsp-deploy" depends="failinproduction-ocsp,ocsp-ear,inputDeployPasswords,inputBootstrapAndDeployPasswords" description="Deploy the standalone OCSP reponder" >
        <antcall target="j2ee:deployocsp" />
        <antcall target="showtime" />
    </target>

    <!-- ======================================================================= -->
    <!-- Make a ZIP release file of EJBCA, and a SHA1 checksum of the release    -->
	<!-- The ZIP file contains all the files used, but not temporary or compile files etc -->
    <!-- ======================================================================= -->
	<target name="ziprelease" description="Make a zip file for EJBCA release">
		<antcall target="clean" />

	<!-- A small script that converts the version x.y.z to x_y_z to be used in the file. JavaScript does not work under Java 1.5. -->
	<scriptdef name="convertdot" language="javascript">
	    <![CDATA[
          ver = project.getProperty("app.version.number");
		  relstring = ver.replace('.','_');
	      //self.log(ver);
	      //self.log(relstring);
		  project.setProperty("ejbca.zipversion", relstring);
          str = project.getProperty("ejbca.zipversion");
	    ]]>
    </scriptdef>
		
		<antcall target="update-svnrev" /> <!-- update svn revision version property -->
		<convertdot/> <!-- convert dots to underscores in version string -->
        <!-- <input message="Version tag for zipfile (ex 3_2_1):" addproperty="ejbca.zipversion" /> -->
		<zip destfile="../ejbca_${ejbca.zipversion}.zip">
		    <zipfileset dir="." prefix="ejbca_${ejbca.zipversion}" filemode="600" dirmode="700"> 
		    	<include name="**/**" />
		    	<exclude name="**/CVS/**" />
		    	<exclude name="tmp/**" />
		    	<exclude name="dist/**" />
		    	<exclude name="ocsp-dist/**" />
		    	<exclude name="bin/META_INF/**" />
		    	<exclude name="out/**" />
		    	<exclude name="p12*/**" />
		    	<exclude name="hwtoken/**" />
		        <exclude name="ocspHardTokenClasses/**" />
		    	<exclude name="**/*.class" />
		    	<exclude name=".classpath" />
		    	<exclude name=".project" />
		    	<exclude name="**/.cvsignore" />
		    	<exclude name="**/ejbca.properties" />
		    	<exclude name="conf/*.properties" />
		    	<exclude name="conf/logdevices/*.properties" />
		    	<exclude name="**/*.sh" />
		    	<exclude name="**/jndi.properties" />
		    	<exclude name="**/hs_err*" />
		    </zipfileset>
		    <zipfileset dir="." prefix="ejbca_${ejbca.zipversion}" filemode="700" dirmode="700"> 
		    	<include name="**/*.sh" />
		    </zipfileset>
		    <zipfileset dir="." prefix="ejbca_${ejbca.zipversion}" filemode="600" dirmode="700">
		    	<include name="conf/extendedkeyusage.properties" />		    	
		    </zipfileset>
		</zip>
        <antcall target="signjar">
            <param name="signjar.file" value="../ejbca_${ejbca.zipversion}.zip"/>
        </antcall>
        <checksum file="../ejbca_${ejbca.zipversion}.zip" algorithm="SHA1" forceOverwrite="yes"/>      
        <checksum file="../ejbca_${ejbca.zipversion}.zip" algorithm="SHA1" property="ejbcaSHA1"/>      
        <echo message="SHA1 checksum: ${ejbcaSHA1}" />
	</target>

    <!-- ======================================================================= -->
    <!-- Display application version string                                      -->
    <!-- ======================================================================= -->
	<target name="ejbcaversion" description="Output application version string.">
		<echo>${app.version}</echo>
	</target>

    <!-- ======================================================================= -->
    <!-- Target updating svn revision string in propertiesAndPaths.xml           -->
    <!-- ======================================================================= -->
	<target name="update-svnrev" description="Updates propertiesAndPaths.xmli file with current trunk SVN revision">
		<echo>Trying to update src/internal.properties with SVN revision of COMMITTED.</echo>
        <property name="revision" value="COMMITTED"/>	
		
        <!-- find out svn.revision of HEAD, need svn.exe installed on local machine will end up in property ${Revision} -->
        <exec executable="svn" output="svnlog.out">
            <arg line="info -r ${revision}"/>
        </exec>
		<loadproperties srcFile="svnlog.out">
		      <filterchain>
		        <linecontains>
		          <contains value="Revision"/>
		        </linecontains>
		      </filterchain>
		</loadproperties>
		<delete file="svnlog.out"/>
		<antcall target="update-svnrev-updatefile" /> <!-- do update of file only if property is set -->
    </target>

	<target name="update-svnrev-updatefile" if="Revision">
		<replaceregexp file="src/internal.properties" encoding="UTF-8" match='(svn.revision=).*'
			replace='\1r${Revision}' />
		<echo>Updated "svn.revision" to: r${Revision}</echo>
    </target>
	
     
	<!--
        Target for signing a JAR (JAR, EAR, WAR or ZIP)
        parameter: signjar.file=file to sign 
	-->
    <target name="signjar">
        <available file="${signjar.keystore}" property="signjar.keystorepresent" value="true"/>	
    	<condition property="signjar.message" value="Using keystore ${signjar.keystore}."
    		else="Specify -Dsignjar.keystore=/path/keystore.jks if you want to sign the release." >
            <isset property="signjar.keystorepresent" />
    	</condition>
    	<echo message="${signjar.message}" />
        <antcall target="signjar.internal" />
    </target>

    <target name="signjar.internal" if="signjar.keystorepresent">
        <echo message="Signing ${signjar.file}" />
        <input message="Enter alias for keystore ${signjar.keystore}:"
        	addproperty="signjar.keystorealias" defaultvalue="releasesigner" /> 
        <input message="Enter password for keystore ${signjar.keystore}:"
        	addproperty="signjar.keystorepass" defaultvalue="foo123" /> 
        <signjar keystore="${signjar.keystore}" jar="${signjar.file}"
        	alias="${signjar.keystorealias}" storepass="${signjar.keystorepass}" />
    </target>

	<!-- ("preprocess" is not run from anywhere right now..) -->
	<target name="preprocess">
        <!-- 
          Fix encoding of files for internal (log) internationalization) 
		  TODO: This looks more like this is something the French language contributor should run before a commit. Should be combined with the diff-script to show missing and redundant translations. 
        --> 		
		<delete file="${tmp}/intresources/intresources.fr.properties"/>
    	<native2ascii encoding="ISO8859-1" 
    		src="${tmp}/intresources" 
    		dest="${tmp}/intresources"
    		includes="intresources.fr.properties" 
    	/>
	</target>
	
	<target name="ejbca.ear.module-dependencies">
    	<ant dir="modules" target="ejbca.ear.module-dependencies"/>
	</target>

	<target name="ejbca.clients">
    	<ant dir="modules" target="ejbca.clients"/>
	</target>

    <target name="ejbca-entity">
    	<ant dir="modules" target="ejbca-entity" />
    </target>

    <target name="ocsp-entity">
    	<ant dir="modules" target="ocsp-entity" />
    </target>

    <target name="generate-dbscripts" description="Generate create and drop script for the configured database.">
    	<ant dir="modules/ejbca-entity" target="generate-dbscripts" />
    </target>

	<target name="ejbca-ejb-interface">
       	<ant dir="modules" target="ejbca-ejb-interface" />
    </target>

	<target name="ocsp-ejb-interface">
       	<ant dir="modules" target="ocsp-ejb-interface" />
    </target>

    <target name="ejbca-ejb-cli" description="Builds EJBCA command line interface">
    	<ant dir="modules" target="ejbca-ejb-cli" />
    </target>
	
    <target name="adminweb.war">
    	<ant dir="modules" target="admin-gui" />
    </target>

    <target name="publicweb.war">
    	<ant dir="modules" target="publicweb-gui" />
    </target>

    <target name="cmp.war">
    	<ant dir="modules" target="cmp-war" />
    </target>

    <target name="healthcheck.war">
    	<ant dir="modules" target="healthcheck-ejbca-war" />
    </target>
		
    <target name="clearcache.war">
    	<ant dir="modules" target="clearcache-ejbca-war" />
    </target>
		
    <target name="ocsphealthcheck.war">
    	<ant dir="modules" target="healthcheck-ocsp-war" />
    </target>	

    <target name="renew.war" if="renew.war.enabled">
    	<ant dir="modules" target="renew-war" />
    </target>   

    <target name="scep.war">
    	<ant dir="modules" target="scep-war" />
    </target>

    <target name="status.war">
    	<ant dir="modules" target="ocsp-ejbca-war" />
    </target>
	
    <target name="ocsp-war">
    	<ant dir="modules" target="ocsp-ocsp-war" />
    </target>

    <target name="webdist.war">
    	<ant dir="modules" target="webdist-war" />
    </target>

	<target name="clientToolBox" description="Builds command line clients as separate toolbox that can be deployed separately">
    	<ant dir="modules" target="clientToolBox" />
    </target>

    <target name="ejbca-cmp-tcp">
    	<ant dir="modules" target="ejbca-cmp-tcp" />
    </target>
	
    <target name="cmpTcpProxy" description="Builds a CMP TCP proxy.">
    	<ant dir="modules" target="cmpTcpProxy" />
    </target>
	
    <target name="cmpHttpProxy" description="Builds a CMP HTTP proxy.">
    	<ant dir="modules" target="cmpHttpProxy" />
    </target>
	
	<target name="showtime" >
		<tstamp>
			<format property="completiontime" pattern="yyyy-MM-dd HH:mm:ss Z"/>
		</tstamp>
		<echo message="Task completed ${completiontime}."/>
	</target>
	
    <target name="ejbcaws.client" description="Build the EJBCA WS-API client">
    	<ant dir="modules" target="ejbca-ws-cli" />
    </target>

    <target name="ejbcaws.war" description="Build the EJBCA WS WAR">
    	<ant dir="modules" target="ejbca-ws"/>
    </target>

    <target name="ejbca-ws-generate">
    	<ant dir="modules" target="ejbca-ws-generate"/>
    </target>

    <target name="xkms.client" description="Build the EJBCA XKMS client">
    	<ant dir="modules" target="ejbca-xkms-cli" />
    </target>

    <target name="xkms.war" description="Build the EJBCA XKMS WAR">
    	<ant dir="modules" target="ejbca-xkms"/>
    </target>
	
	<target name="externalra-service">
    	<ant dir="modules" target="externalra-service"/>
	</target>

	<target name="externalra-client">
    	<ant dir="modules" target="externalra-client"/>
	</target>

	<target name="externalra-scep" description="Build the EJBCA External RA StandAlone SCEP application">
    	<ant dir="modules" target="externalra-scep"/>
	</target>

	<target name="externalra-scep-deploy" description="Deploy the EJBCA External RA StandAlone SCEP application" depends="externalra-scep">
        <antcall target="j2ee:deploy-scep-war" />
	</target>

	<target name="externalra-gui" description="Build the EJBCA External RA StandAlone GUI application">
    	<ant dir="modules" target="externalra-gui"/>
	</target>

	<target name="externalra-gui-deploy" description="Deploy the EJBCA External RA StandAlone GUI application" depends="externalra-gui">
        <antcall target="j2ee:deploy-externalragui-war" />
	</target>

	<target name="batchenrollment-gui" description="Build the EJBCA Batch Enrollment StandAlone GUI application" depends="ejbcaws.client">
    	<ant dir="modules" target="batchenrollment-gui"/>
	</target>

	<target name="jbosslogsigning" description="Build signing Log4j appended for JBoss">
    	<ant dir="modules" target="appserver-ext-jbosslogsigning"/>
	</target>

	<target name="jbosslog4jsafer" description="Build Log4j ErrorHandler and Appender extensions for JBoss">
    	<ant dir="modules" target="appserver-ext-jbosslog4jsafer"/>
	</target>
</project>
