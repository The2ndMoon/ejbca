<!-- 
****************************************************************************************************
****																							****
**** 	ANT script for restoring backups. This script will restore database and configuration 	****
****	from an inputed backup file.															****
****																							****	
****************************************************************************************************
$Id$
 -->

<project name="restore" basedir="../.." default="restore">

	<import file="backupCommons.xml"/>

	<property name="decrypted.filename" value="decryptedBackup.zip" />
	
	<target name="restore">
		<input message="Please enter file to restore from." addproperty="backup.file"/>
		<input message="Please input working directory(e.g /tmp)" addproperty="working.dir"/>
		<antcall target="decryptBackup" /> 
		<antcall target="unArchiveBackupFiles" />
		<antcall target="restoreDatabase" />
		<antcall target="cleanTemporaryFiles" /<
	</target>
	
	<target name="decryptBackup">
		<echo>Decrypting backup file ${backup.filename}</echo>
		<input message="Please enter shared library name" addproperty="shared.library.name"/>
		<input message="Please enter slot number. Start with 'i' to indicate index in list" addproperty="slot.number"/>
		<input message="Please enter key alias" addproperty="key.alias" />
		<java jar="dist/clientToolBox/clientToolBox.jar" fork="true">
			<arg line="PKCS11HSMKeyTool decrypt ${shared.library.name} ${slot.number} ${backup.file} ${working.dir}/${decrypted.filename} ${key.alias}" />
		</java>
	</target>
	
	<target name="unArchiveBackupFiles">
		<echo>Unarchiving ${backup.file}</echo>
		<unzip src="${backup.file}" dest="${working.dir}" overwrite="true"/>
		<echo>Restoring ${ejbca.home}/conf/</echo>
		<unzip src="${working.dir}/${filename.conf}" dest="${ejbca.home}/conf/" overwrite="true"/>
		<echo>Restoring ${working.dir}/${filename.p12}</echo>
		<unzip src="${working.dir}/${filename.p12}" dest="${ejbca.home}/p12" overwrite="true" />		
	</target>

	<target name="restoreDatabase">
		<echo>Restoring database from ${working.dir}/${filename.dumpfile}</echo>
		<input message="Please enter database root username" addproperty="database.root.username"/>
		<input message="Please enter database root password" addproperty="database.root.password">
			<handler classname="org.apache.tools.ant.input.SecureInputHandler" />
		</input>
		<condition property="database.restore.command" value="${database.home}/bin/mysql -h${database.host} --port=${database.port} -u${database.root.username} -p${database.root.password} ejbca -e &quot;source ${working.dir}/${filename.dumpfile}&quot;"><equals arg1="${database.name}" arg2="mysql"/></condition>
		<condition property="database.restore.command" value="${database.home}/bin/pg_restore -c -w -h${database.host} -U${database.root.username} -d$ejbca ${working.dir}/${filename.dumpfile}"><equals arg1="${database.name}" arg2="postgres"/></condition>	
		<exec command="${database.restore.command}">
			<env key="PGPASSWORD" value="${database.root.password}"/>	
		</exec>
	</target>
	
	<target name="cleanTemporaryFiles">
		<delete file="${working.dir}/${filename.p12}" />
		<delete file="${working.dir}/${filename.conf}" />
		<delete file="${working.dir}/${filename.dumpfile}" />
	</target>
</project>