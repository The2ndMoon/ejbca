<?xml version="1.0" encoding="UTF-8"?>
<project name="ejbca-ejb-cli" default="build">
    <description>
            Build file for the remote EJB access CLI
    </description>

	<dirname property="this.dir" file="${ant.file.ejbca-ejb-cli}"/>
	<import file="${this.dir}/../build.xml"/>
	
	<property name="build.dir" location="${this.dir}/build"/>
	<property name="src.dir" location="${this.dir}/src"/>

	<path id="compile.classpath">
		<path location="${mod.ejbca-ejb-interface.lib}"/>
		<path refid="lib.ejbca-util.classpath"/>
		<path refid="lib.bouncycastle.classpath"/>
		<path refid="lib.log4j.classpath"/>
		<path refid="lib.ldap.classpath"/>
		<path refid="lib.commons-lang.classpath"/>
		<path refid="lib.commons-config.classpath"/>
		<path refid="lib.commons-collections.classpath"/>
		<path refid="lib.commons-logging.classpath"/>
		<path location="${mod.ejbca-ejb-interface_ejb3.lib}"/>
		<path refid="lib.batik.classpath"/>	<!-- SVGTemplatePrinter -->
	</path>
	
    <target name="build" description="Build this module" depends="compile">
    	<!-- OC4J requires a META-INF/application-client.xml file -->
    	<mkdir dir="${build.dir}/META-INF"/>
    	<condition property="application-client.filter" value="application-client.xml" else="nofile">
    		<equals arg1="${appserver.type}" arg2="oracle"/>
    	</condition>
    	<copy todir="${build.dir}/META-INF">
    		<fileset dir="${ejbca.home}/src/deploy/oracle/client/bin/META-INF" includes="${application-client.filter}"/>
    	</copy>
    	<!-- Upgrade of certificate profiles requires extendedkeyusage.properties -->
    	<mkdir dir="${build.dir}/conf"/>
    	<copy todir="${build.dir}/conf">
    		<fileset dir="${ejbca.home}/conf" includes="extendedkeyusage.properties"/>
    	</copy>
    	<!-- Create the JAR -->
    	<pathconvert property="ejbca-ejb-cli.dependencies" pathsep=" ">
    	    <path>
	        	<fileset dir="${mod.ejbca-ejb-cli.dist}" includes="lib/*.jar"/>
    	    </path>
    		<map from="${mod.ejbca-ejb-cli.dist}/" to=""/>
    	</pathconvert>
    	<dirname file="${mod.ejbca-ejb-cli.lib}" property="mod.ejbca-ejb-cli.lib.dir"/>
    	<mkdir dir="${mod.ejbca-ejb-cli.lib.dir}" />	<!-- Make sure the dir exists before we start the jar-task -->
    	<jar destfile="${mod.ejbca-ejb-cli.lib}">
    		<manifest>
    			<attribute name="Class-path" value="${ejbca-ejb-cli.dependencies} ./" />
    			<attribute name="Main-Class" value="org.ejbca.ui.cli.EjbcaEjbCli"/>
    		</manifest>
   			<fileset dir="${build.dir}" includes="**/*.class **/*.xml **/*.properties"/>
    	</jar>
    </target>

    <target name="clean" description="Clean up this module">
		<delete dir="${build.dir}" />
		<delete file="${mod.ejbca-ejb-cli.lib}" />
    	<delete dir="${mod.ejbca-ejb-cli.dist}" />
    </target>
	
    <target name="compile" depends="setup">
    	<mkdir dir="${build.dir}" />
        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<path refid="lib.jee.classpath"/>
        	</classpath>
    	</javac>
    </target>

    <target name="setup" depends="ejbca-util, ejbca-ejb-interface">
    	<mkdir dir="${mod.ejbca-ejb-cli.dist}" />
    	<mkdir dir="${mod.ejbca-ejb-cli.dist}/lib" />
    	<pathconvert property="lib.compile.classpath.property" pathsep=" ">
    	    <path refid="compile.classpath" />
    		<map from="${ejbca.home}/" to=""/>
    	</pathconvert>
    	<copy todir="${mod.ejbca-ejb-cli.dist}/lib" flatten="true">
    		<fileset dir="${ejbca.home}" includes="${lib.compile.classpath.property}"/>
    	</copy>
    	<!-- Add the client libraries from the app server -->
    	<pathconvert property="lib.jee.classpath.property" pathsep=" ">
    		<path refid="lib.jee.classpath"/>
    		<map from="${appserver.home.parent}/" to=""/>
    	</pathconvert>
    	<copy todir="${mod.ejbca-ejb-cli.dist}/lib" flatten="true" verbose="true">
    		<fileset dir="${appserver.home.parent}" includes="${lib.jee.classpath.property}"/>
    	</copy>
    	<copy todir="${mod.ejbca-ejb-cli.dist}">
    		<fileset dir="${ejbca.home}/src/java" includes="jndi.properties"/>
    		<fileset dir="${ejbca.home}/src" includes="intresources/intresources.*.properties"/>
    		<fileset dir="${ejbca.home}/bin" includes="batchtool.properties"/>
    	</copy>
        <copy file="${log4j.cli.file}" tofile="${mod.ejbca-ejb-cli.dist}/log4j.xml" failonerror="true"/>
		<copy file="${ejbca.home}/conf/jndi.properties.${appserver.type}" tofile="${mod.ejbca-ejb-cli.dist}/jndi.properties" failonerror="true"/>
    </target>

</project>
