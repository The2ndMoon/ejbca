<?xml version="1.0" encoding="UTF-8"?>
<project name="ejbca-entity" default="build">
    <description>
            Contains all JPA entity classes
    </description>

	<dirname property="this.dir" file="${ant.file.ejbca-entity}"/>
	<import file="${this.dir}/../build.xml"/>
	
	<property name="build.dir" location="${this.dir}/build"/>
	<property name="build-test.dir" location="${this.dir}/build-test"/>
	<property name="src.dir" location="${this.dir}/src"/>
	<property name="src-test.dir" location="${this.dir}/src-test"/>
	<property name="resources.dir" location="${this.dir}/resources"/>

	<path id="compile.classpath">
		<path refid="lib.utils.classpath"/>
		<path refid="lib.jpa.classpath"/>
		<path refid="lib.ejbca-util.classpath"/>
		<path refid="lib.bouncycastle.classpath"/>
	</path>

	<path id="compile-test.classpath">
		<path refid="compile.classpath"/>
	</path>
	
	<path id="jdbc-jars.classpath">
		<fileset dir="${jdbc-loc}" includes="*.jar"/>
	</path>

	<path id="jpavalidation.classpath">
		<path refid="compile-test.classpath"/>
		<path refid="lib.batik.classpath"/>	<!-- we only need xerces -->
		<path refid="jdbc-jars.classpath"/>
		<path location="${build-test.dir}"/>
		<path location="${mod.ejbca-entity.lib}"/>
	</path>

    <target name="clean" description="Clean up this module">
		<delete dir="${build.dir}" />
		<delete dir="${build-test.dir}" />
		<delete file="${mod.ejbca-entity.lib}" />
    </target>
	
    <target name="build" description="Build this module" depends="compile">
    	<jar destfile="${mod.ejbca-entity.lib}" basedir="${build.dir}" includes="**/*.class"/>
    </target>

    <target name="compile" depends="ejbca-util">
    	<mkdir dir="${build.dir}" />
        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}" classpathref="compile.classpath"/>
    </target>

    <target name="test" description="Test this module. Use -Djdbc-loc=/path-to-jdbc-jars/" depends="compile-test">
        <copy file="${resources.dir}/log4j.xml" tofile="${build-test.dir}/log4j.xml" />
    	<mkdir dir="${build-test.dir}/META-INF"/>
		<available property="test-mysql" classname="com.mysql.jdbc.Driver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-mysql"/>
		<available property="test-oracle" classname="oracle.jdbc.driver.OracleDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-oracle"/>
		<available property="test-db2" classname="com.ibm.db2.jcc.DB2Driver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-db2"/>
		<available property="test-derby" classname="org.apache.derby.jdbc.ClientDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-derby"/>
		<available property="test-postgres" classname="org.postgresql.Driver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-postgres"/>
		<available property="test-hsqldb" classname="org.hsqldb.jdbcDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-hsqldb"/>
		<available property="test-ingres" classname="com.ingres.jdbc.IngresDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-ingres"/>
    	<!--
		<available property="test-informix" classname="com.informix.jdbc.IfxDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-informix"/>
    	-->
    </target>

    <target name="test-mysql" if="test-mysql">
    	<copy file="${resources.dir}/persistence-test-mysql.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-mysql.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-oracle" if="test-oracle">
    	<copy file="${resources.dir}/persistence-test-oracle.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-oracle.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-db2" if="test-db2">
    	<copy file="${resources.dir}/persistence-test-db2.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-db2.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-derby" if="test-derby">
    	<copy file="${resources.dir}/persistence-test-derby.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-derby.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-postgres" if="test-postgres">
    	<copy file="${resources.dir}/persistence-test-postgres.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-postgres.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-hsqldb" if="test-hsqldb">
    	<copy file="${resources.dir}/persistence-test-hsqldb.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-hsqldb.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-ingres" if="test-ingres">
    	<copy file="${resources.dir}/persistence-test-ingres.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-ingres.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="compile-test" depends="ejbca-util, build">
    	<mkdir dir="${build-test.dir}" />
        <javac srcdir="${src-test.dir}" destdir="${build-test.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}" classpathref="compile-test.classpath"/>
    </target>

</project>
