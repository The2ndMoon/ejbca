<?xml version="1.0" encoding="UTF-8"?>
<project name="ejbca-entity" default="build">
    <description>
            Contains all JPA entity classes.
    </description>

	<dirname property="this.dir" file="${ant.file.ejbca-entity}"/>
	<import file="${this.dir}/../build.xml"/>
	
	<property name="build.dir" location="${this.dir}/build"/>
	<property name="build-test.dir" location="${this.dir}/build-test"/>
	<property name="src.dir" location="${this.dir}/src"/>
	<property name="src-test.dir" location="${this.dir}/src-test"/>
	<property name="resources.dir" location="${this.dir}/resources"/>

	<path id="compile.classpath">
		<path refid="lib.utils.classpath"/>
		<path refid="lib.jpa.classpath"/>
		<path refid="lib.ejbca-util.classpath"/>
		<path refid="lib.bouncycastle.classpath"/>
	</path>

	<path id="compile-test.classpath">
		<path refid="compile.classpath"/>
	</path>
	
	<path id="jdbc-jars.classpath">
		<fileset dir="${jdbc-loc}" includes="*.jar"/>
	</path>

	<path id="jpavalidation.classpath">
		<path refid="compile-test.classpath"/>
		<path refid="lib.batik.classpath"/>	<!-- we only need xerces -->
		<path refid="jdbc-jars.classpath"/>
		<path location="${build-test.dir}"/>
		<path location="${mod.ejbca-entity.lib}"/>
	</path>

    <target name="clean" description="Clean up this module">
		<delete dir="${build.dir}" />
		<delete dir="${build-test.dir}" />
		<delete file="${mod.ejbca-entity.lib}" />
		<delete file="${mod.ocsp-entity.lib}" />
    </target>
	
    <target name="build" description="Build this module" depends="compile, handlepersistence, handleorm">
    	<jar destfile="${mod.ejbca-entity.lib}" basedir="${build.dir}" includes="**/*.class **/*.xml"/>
    </target>

    <target name="build-ocsp" description="Build this module" depends="compile, handlepersistence, handleorm-ocsp">
    	<jar destfile="${mod.ocsp-entity.lib}" basedir="${build.dir}" includes="**/CertificateData.class **/*.xml"/>
    </target>

    <target name="compile" depends="ejbca-util">
    	<mkdir dir="${build.dir}" />
        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}" classpathref="compile.classpath"/>
    </target>

    <target name="handlepersistence">
    	<echo message="Database type:      ${database.name}"/>
    	<echo message="DataSource mapping: ${datasource.jndi-name-prefix}${datasource.jndi-name}"/>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.DB2Dialect"><equals arg1="${database.name}" arg2="db2"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.DerbyDialect"><equals arg1="${database.name}" arg2="derby"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"><equals arg1="${database.name}" arg2="hsqldb"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.InformixDialect"><equals arg1="${database.name}" arg2="informix"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.IngresDialect"><equals arg1="${database.name}" arg2="ingres"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.SQLServerDialect"><equals arg1="${database.name}" arg2="mssql"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.MySQLDialect"><equals arg1="${database.name}" arg2="mysql"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.Oracle10gDialect"><equals arg1="${database.name}" arg2="oracle"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"><equals arg1="${database.name}" arg2="postgres"/></condition>
    	<condition property="hibernate.dialect" value="org.hibernate.dialect.SybaseDialect"><equals arg1="${database.name}" arg2="sybase"/></condition>
    	<fail unless="hibernate.dialect" message="Unsupported database type '${database.name}'."/>
    	<mkdir dir="${build.dir}/META-INF"/>
    	<copy file="${resources.dir}/persistence-ds-template.xml" tofile="${build.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true">
    		<filterchain>
				<expandproperties/>
    		</filterchain>
    	</copy>
    </target>

    <target name="handleorm">
		<copy file="${resources.dir}/orm-${database.name}.xml" tofile="${build.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
	</target>

    <target name="handleorm-ocsp">
		<copy file="${resources.dir}/orm-ocsp-${database.name}.xml" tofile="${build.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
	</target>

    <target name="compile-ocsp" depends="ejbca-util">
    	<mkdir dir="${build.dir}" />
        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}" classpathref="compile.classpath"/>
    </target>


    <target name="test" description="Perform database schema validation for all databases where the JDBC driver is available." depends="compile-test">
    	<fail unless="jdbc-loc" message="Use -Djdbc-loc=/path-to-jdbc-jars/ to specify the directory with the JDBC driver JARs."/>
        <copy file="${resources.dir}/log4j.xml" tofile="${build-test.dir}/log4j.xml" />
    	<mkdir dir="${build-test.dir}/META-INF"/>
		<available property="test-db2" classname="com.ibm.db2.jcc.DB2Driver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-db2"/>
		<available property="test-derby" classname="org.apache.derby.jdbc.ClientDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-derby"/>
		<available property="test-hsqldb" classname="org.hsqldb.jdbcDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-hsqldb"/>
		<available property="test-informix" classname="com.informix.jdbc.IfxDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-informix"/>
		<available property="test-ingres" classname="com.ingres.jdbc.IngresDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-ingres"/>
		<available property="test-mssql" classname="com.microsoft.sqlserver.jdbc.SQLServerDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-mssql"/>
		<available property="test-mysql" classname="com.mysql.jdbc.Driver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-mysql"/>
		<available property="test-oracle" classname="oracle.jdbc.driver.OracleDriver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-oracle"/>
		<available property="test-postgres" classname="org.postgresql.Driver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-postgres"/>
		<available property="test-sybase" classname="net.sourceforge.jtds.jdbc.Driver" classpathref="jdbc-jars.classpath"/>
		<antcall target="test-sybase"/>
    </target>

    <target name="test-mysql" if="test-mysql">
    	<copy file="${resources.dir}/persistence-test-mysql.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-mysql.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-oracle" if="test-oracle">
    	<copy file="${resources.dir}/persistence-test-oracle.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-oracle.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-db2" if="test-db2">
    	<copy file="${resources.dir}/persistence-test-db2.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-db2.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-derby" if="test-derby">
    	<copy file="${resources.dir}/persistence-test-derby.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-derby.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-postgres" if="test-postgres">
    	<copy file="${resources.dir}/persistence-test-postgres.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-postgres.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-hsqldb" if="test-hsqldb">
    	<copy file="${resources.dir}/persistence-test-hsqldb.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-hsqldb.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-ingres" if="test-ingres">
    	<copy file="${resources.dir}/persistence-test-ingres.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-ingres.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-mssql" if="test-mssql">
    	<copy file="${resources.dir}/persistence-test-mssql.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-mssql.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-sybase" if="test-sybase">
    	<copy file="${resources.dir}/persistence-test-sybase.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-sybase.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

	<!-- This test wont work if the DB2 JDBC driver is in the class-path as well. -->
    <target name="test-informix" if="test-informix" depends="test-informix-check">
    	<copy file="${resources.dir}/persistence-test-informix.xml" tofile="${build-test.dir}/META-INF/persistence.xml" failonerror="true" overwrite="true"/>
    	<copy file="${resources.dir}/orm-informix.xml" tofile="${build-test.dir}/META-INF/orm.xml" failonerror="true" overwrite="true"/>
    	<java classname="org.ejbca.core.ejb.ValidateJpaSchema" classpathref="jpavalidation.classpath"/>
    </target>

    <target name="test-informix-check" if="test-db2">
    	<echo message="WARNING: Mixing Informix and DB2 JDBC drivers will probably not work!" level="warning"/>
	</target>

    <target name="compile-test" depends="ejbca-util, build">
    	<mkdir dir="${build-test.dir}" />
        <javac srcdir="${src-test.dir}" destdir="${build-test.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}" classpathref="compile-test.classpath"/>
    </target>

</project>
