<?xml version="1.0" encoding="UTF-8"?>
<project name="ejbca-ejb" default="build">
    <description>
            The EJBCA EJB component.
    	
    		The EJBCA util library is also built from this source.
    </description>

	<dirname property="this.dir" file="${ant.file.ejbca-ejb}"/>
	<import file="${this.dir}/../build.xml"/>
	
	<property name="build.dir" location="${this.dir}/build"/>
	<property name="build-util.dir" location="${this.dir}/build-util"/>
	<property name="build-common-web.dir" location="${this.dir}/build-common-web"/>
	<property name="build-va.dir" location="${this.dir}/build-va"/>
	<property name="build-test.dir" location="${this.dir}/build-test"/>
	<property name="src.dir" location="${ejbca.home}/src/java"/>
	<property name="src-test.dir" location="${this.dir}/src-test"/>
	<property name="resources.dir" location="${this.dir}/resources"/>
	<property name="reports.base.dir" location="${this.dir}/build-test/reports/"/>
	<property name="internalresources.base.dir" location="${ejbca.home}/src"/>

	<path id="compile-util.classpath">
		<path refid="lib.cert-cvc.classpath"/>
		<path refid="lib.bouncycastle.classpath"/>
		<path refid="lib.log4j.classpath"/>
		<path refid="lib.commons-lang.classpath"/>
		<path refid="lib.commons-config.classpath"/>
		<path refid="lib.commons-collections.classpath"/>
		<path refid="lib.commons-logging.classpath"/>
		<path refid="lib.servlet.classpath"/>
		<path refid="lib.ldap.classpath"/>
		<path refid="lib.mail.classpath"/>
		<path refid="lib.batik.classpath"/>
		<path refid="lib.xmlsec.classpath"/>
		<path refid="lib.jee.classpath"/>
	</path>

	<path id="compile-common-web.classpath">
		<path refid="compile-util.classpath"/>
		<path refid="lib.ejbca-util.classpath"/>
		<path location="${mod.ejbca-ejb-interface.lib}"/>
	</path>

	<path id="compile-ejbca-ejb.classpath">
		<path refid="compile-util.classpath"/>
		<path refid="lib.ejbca-common-web.classpath"/>
		<path location="${mod.ejbca-ejb-interface.lib}"/>
		<path location="${mod.ejbca-entity.lib}"/>
		<path refid="lib.quickserver.classpath"/>
	</path>

	<path id="compile-va-ejb.classpath">
		<path refid="compile-util.classpath"/>
		<pathelement location="${mod.va-ejb-interface.lib}"/>
		<pathelement location="${mod.va-entity.lib}"/>
	</path>

	<path id="compile-test.classpath">
		<path refid="compile-util.classpath"/>
		<path location="${mod.ejbca-common-web.lib}"/>
		<path location="${mod.ejbca-ejb.lib}"/>	<!-- TODO: Refactor so this isn't neccessary for building the tests..? -->
		<path refid="lib.ejbca-util.classpath"/>
		<path refid="lib.junit.classpath"/>
		<path location="${mod.ejbca-ejb-interface.lib}"/>
		<path location="${mod.ejbca-entity.lib}"/>
	</path>
	
	<path id="test.classpath">
		<path location="${build-test.dir}" />
		<path location="${mod.ejbca-ejb.lib}" />
		<path location="${mod.ejbca-util.lib}" />
		<path location="${mod.ejbca-ejb-interface.lib}"/>
		<path refid="compile-test.classpath"/>
		<path refid="lib.junit.classpath"/>
	</path>

	<!--
		EJBCA util depends on the CVC library and used by many modules in EJBCA and also in SignServer.
	-->
	<fileset id="source.fileset.ejbca-util" dir="${src.dir}">
    	<!-- From EJBCA WS common lib -->
       	<include name="org/ejbca/core/model/SecConst.java"/>
    	<include name="org/ejbca/core/model/approval/ApprovalRequestExecutionException.java"/>
    	<include name="org/ejbca/core/model/approval/ApprovalRequestExpiredException.java"/>
       	<include name="org/ejbca/core/model/approval/WaitingForApprovalException.java"/>
       	<include name="org/ejbca/core/model/approval/ApprovalException.java"/>
       	<include name="org/ejbca/core/model/authorization/AuthorizationDeniedException.java"/>
       	<include name="org/ejbca/core/model/ca/SignRequestException.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/CADoesntExistsException.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/PublisherException.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenDoesntExistsException.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenExistsException.java"/>
       	<include name="org/ejbca/core/model/ra/AlreadyRevokedException.java"/>
       	<include name="org/ejbca/core/model/ra/NotFoundException.java"/>
       	<include name="org/ejbca/core/model/ra/UserDataConstants.java"/>
       	<include name="org/ejbca/core/model/ra/raadmin/UserDoesntFullfillEndEntityProfile.java"/>
       	<include name="org/ejbca/core/model/ra/userdatasource/MultipleMatchException.java"/>
       	<include name="org/ejbca/core/model/ra/userdatasource/UserDataSourceException.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenConstants.java"/>
    	<include name="org/ejbca/util/CertTools.java"/>
       	<include name="org/ejbca/util/query/IllegalQueryException.java"/>
       	<include name="org/ejbca/util/query/BasicMatch.java"/>
       	<include name="org/ejbca/util/query/UserMatch.java"/>
    	<!-- From EJBCA WS CLI (including some of the classes above) -->
       	<include name="org/ejbca/ui/cli/ErrorAdminCommandException.java"/>
       	<include name="org/ejbca/ui/cli/IAdminCommand.java"/>
       	<include name="org/ejbca/ui/cli/IllegalAdminCommandException.java"/>
       	<include name="org/ejbca/util/keystore/P11Slot.java"/>
       	<include name="org/ejbca/util/provider/TLSProvider.java"/>
       	<include name="org/ejbca/util/provider/TrustManagerFactoryImpl.java"/>
       	<include name="org/ejbca/util/provider/X509TrustManagerAcceptAll.java"/>
       	<include name="org/ejbca/util/PerformanceTest.java"/>
       	<include name="org/ejbca/util/RequestMessageUtils.java"/>
    	<!-- From EJBCA XKMS CLI (including some of the classes above) -->
       	<include name="org/ejbca/util/keystore/P12toPEM.java"/>
    	<!-- From EJBCA EJB interfaces (including some of the classes above) -->
       	<include name="org/ejbca/core/model/log/Admin.java"/>
       	<include name="org/ejbca/core/model/approval/AdminAlreadyApprovedRequestException.java"/>
       	<include name="org/ejbca/core/model/approval/ApprovalDataVO.java"/>
       	<include name="org/ejbca/core/model/approval/Approval.java"/>
       	<include name="org/ejbca/util/query/Query.java"/>
       	<include name="org/ejbca/core/model/authorization/AdminGroup.java"/>
       	<include name="org/ejbca/core/model/authorization/AdminGroupExistsException.java"/>
       	<include name="org/ejbca/core/model/authorization/AuthenticationFailedException.java"/>
       	<include name="org/ejbca/core/model/ca/AuthStatusException.java"/>
       	<include name="org/ejbca/core/model/ca/AuthLoginException.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/CA.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/CAExistsException.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/CAInfo.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/IllegalKeyStoreException.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/PublisherQueueVolatileData.java"/>
       	<include name="org/ejbca/core/model/ra/ExtendedInformation.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/PublisherConnectionException.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/BasePublisher.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/PublisherQueueData.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/PublisherExistsException.java"/>
       	<include name="org/ejbca/core/model/ca/IllegalKeyException.java"/>
       	<include name="org/ejbca/core/model/ca/SignRequestSignatureException.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/ExtendedCAServiceInfo.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/ExtendedCAServiceRequestException.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/IllegalExtendedCAServiceRequestException.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/ExtendedCAServiceNotActiveException.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/ExtendedCAServiceRequest.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/ExtendedCAServiceResponse.java"/>
       	<include name="org/ejbca/core/ejb/ca/store/CertificateStatus.java"/>
       	<include name="org/ejbca/core/model/ca/store/CertificateInfo.java"/>
       	<include name="org/ejbca/core/model/ca/store/CRLInfo.java"/>
       	<include name="org/ejbca/core/model/ca/store/CertReqHistory.java"/>
       	<include name="org/ejbca/core/model/ca/certificateprofiles/CertificateProfileExistsException.java"/>
       	<include name="org/ejbca/core/model/ca/certificateprofiles/CertificateProfile.java"/>
       	<include name="org/ejbca/core/model/hardtoken/UnavailableTokenException.java"/>
       	<include name="org/ejbca/core/model/hardtoken/profiles/HardTokenProfile.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenProfileExistsException.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenIssuer.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenIssuerData.java"/>
       	<include name="org/ejbca/core/model/hardtoken/types/HardToken.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenData.java"/>
       	<include name="org/ejbca/core/model/keyrecovery/KeyRecoveryData.java"/>
       	<include name="org/ejbca/core/model/log/ILogExporter.java"/>
       	<include name="org/ejbca/core/model/log/LogConfiguration.java"/>
       	<include name="org/ejbca/core/model/log/ILogDevice.java"/>
       	<include name="org/ejbca/core/model/protect/TableVerifyResult.java"/>
       	<include name="org/ejbca/core/model/ra/raadmin/AdminPreference.java"/>
       	<include name="org/ejbca/core/model/ra/raadmin/EndEntityProfile.java"/>
       	<include name="org/ejbca/core/model/ra/raadmin/EndEntityProfileExistsException.java"/>
       	<include name="org/ejbca/core/model/ra/userdatasource/BaseUserDataSource.java"/>
       	<include name="org/ejbca/core/model/ra/userdatasource/UserDataSourceExistsException.java"/>
       	<include name="org/ejbca/core/model/services/ServiceExistsException.java"/>
       	<include name="org/ejbca/core/model/services/ServiceConfiguration.java"/>
       	<include name="org/ejbca/util/ValueExtractor.java"/>
    	<!-- From EJBCA EJB CLI (including some of the classes above) -->
       	<include name="org/ejbca/core/ejb/ServiceLocator.java"/>
       	<include name="org/ejbca/core/protocol/X509ResponseMessage.java"/>
       	<include name="org/ejbca/util/PluginTool.java"/>
       	<include name="org/ejbca/util/PrinterManager.java"/>
       	<include name="org/ejbca/core/model/authorization/AccessRulesConstants.java"/>
       	<include name="org/ejbca/core/model/ra/UserAdminConstants.java"/>
    	<include name="org/ejbca/core/model/ra/raadmin/*Profile.java"/>
    	<include name="org/ejbca/core/model/ra/raadmin/*Exception.java"/>
       	<include name="org/ejbca/util/CliTools.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/X509CA.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/X509CAInfo.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/CVCCA.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/CVCCAInfo.java"/>
       	<include name="org/ejbca/core/model/hardtoken/types/EnhancedEIDHardToken.java"/>
       	<include name="org/ejbca/core/model/hardtoken/types/SwedishEIDHardToken.java"/>
       	<include name="org/ejbca/core/model/hardtoken/profiles/IPINEnvelopeSettings.java"/>
       	<include name="org/ejbca/core/model/hardtoken/profiles/SwedishEIDProfile.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/CmsCAServiceInfo.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/OCSPCAServiceInfo.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/extendedcaservices/XKMSCAServiceInfo.java"/>
       	<include name="org/ejbca/core/model/ca/catoken/SoftCATokenInfo.java"/>
       	<include name="org/ejbca/core/model/ca/catoken/HardCATokenInfo.java"/>
       	<include name="org/ejbca/core/model/ca/catoken/KeyStrings.java"/>
       	<include name="org/ejbca/core/model/ca/catoken/NFastCAToken.java"/>
    	<include name="org/ejbca/core/model/ca/certificateprofiles/*CertificateProfile.java"/>
    	<include name="org/ejbca/core/model/ca/certificateprofiles/*Exception.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/*Publisher.java"/> <!-- Needed for profile imports to upgrade profiles -->
       	<exclude name="org/ejbca/core/model/ca/publisher/ExternalOCSPPublisher.java"/> <!-- But not this one, is has EJB dependencies -->
       	<include name="org/ejbca/util/keystore/KeyStoreContainerFactory.java"/>
    	<!-- From EJBCA External SCEP RA (including some of the classes above) -->
       	<include name="org/ejbca/core/protocol/scep/ScepRequestMessage.java"/>
       	<include name="org/ejbca/core/protocol/scep/ScepResponseMessage.java"/>
    	<!-- From EJBCA External RA GUI (including some of the classes above) -->
       	<include name="com/novosec/pkix/asn1/**/*.java"/>
       	<include name="org/ejbca/util/GUIDGenerator.java"/>
    	<!-- Dependencies from SignServer -->
    	<!-- Execute "grep "import.*org.ejbca.*" src/ -r | grep -v svn | awk '{print $2}' | tr -d ';' | sort | uniq" in the SignServer home dir to get a list of dependencies. -->
       	<include name="org/ejbca/core/ejb/JNDINames.java"/>
       	<include name="org/ejbca/model/ca/caadmin/IllegalKeyStoreException.java"/>
       	<include name="org/ejbca/model/ca/catoken/CATokenAuthenticationFailedException.java"/>
       	<include name="org/ejbca/model/ca/catoken/CATokenOfflineException.java"/>
       	<include name="org/ejbca/model/ca/catoken/ICAToken.java"/>
       	<include name="org/ejbca/model/ca/catoken/PKCS11CAToken.java"/>
       	<include name="org/ejbca/model/ca/crl/RevokedCertInfo.java"/>
       	<include name="org/ejbca/model/UpgradeableDataHashMap.java"/>
       	<include name="org/ejbca/ui/cli/util/ConsolePasswordReader.java"/>
       	<include name="org/ejbca/ui/web/pub/cluster/IHealthCheck.java"/>
       	<include name="org/ejbca/util/Base64.java"/>
       	<include name="org/ejbca/util/Base64GetHashMap.java"/>
       	<include name="org/ejbca/util/Base64PutHashMap.java"/>
       	<include name="org/ejbca/util/CertTools.java"/>
       	<include name="org/ejbca/util/JDBCUtil.java"/>
       	<include name="org/ejbca/util/keystore/KeyTools.java"/>
       	<include name="org/ejbca/util/PatternLogger.java"/>
       	<include name="org/ejbca/util/IPatternLogger.java"/>
    	<!-- General test helpers -->
       	<include name="org/ejbca/util/NonEjbTestTools.java"/>
    	<!-- Dependencies from Public Web WAR -->
       	<include name="org/ejbca/config/WebConfiguration.java"/>
       	<include name="org/ejbca/config/InternalConfiguration.java"/>
    	<!-- Dependencies from EJB Entity -->
       	<include name="org/ejbca/core/model/approval/ApprovalDataUtil.java"/>
       	<include name="org/ejbca/core/model/log/LogEntry.java"/>
       	<include name="org/ejbca/core/model/ca/caadmin/CACacheManager.java"/>
    	<!-- Dependencies from CMP TCP WAR -->
       	<include name="org/ejbca/ui/web/LimitLengthASN1Reader.java"/>
       	<include name="org/ejbca/config/CmpConfiguration.java"/>
    	<!-- Dependencies from OCSP WAR -->
       	<include name="org/ejbca/core/protocol/ocsp/ISaferAppenderListener.java"/>
	</fileset>
	<pathconvert refid="source.fileset.ejbca-util" pathsep=" " property="source.fileset.ejbca-util.files"><map from="${src.dir}/" to=""/></pathconvert>

	<!--
		EJBCA Common Web depends on ejbca-util, ejbca-ejb-interface and used by many modules in EJBCA.
	-->
	<fileset id="source.fileset.ejbca-common-web" dir="${src.dir}">
    	<!-- Dependencies from Public Web, Admin GUI, SCEP WAR, Web Dist WAR, CMP WAR, -->
       	<include name="org/ejbca/ui/web/RequestHelper.java"/>
       	<include name="org/ejbca/ui/web/RevokedInfoView.java"/>	<!-- Move to AdminGUI src -->
		<include name="org/ejbca/ui/web/CertificateView.java"/>
       	<include name="org/ejbca/util/HTMLTools.java"/>
    	<!-- Dependencies from Public, EJBCA WS and approvals -->
       	<include name="org/ejbca/core/model/util/GenerateToken.java"/>
    	<!-- Dependencies from Admin GUI and EJBs -->
       	<include name="org/ejbca/core/model/authorization/Authorizer.java"/>
       	<include name="org/ejbca/core/model/ra/RAAuthorization.java"/>
       	<include name="org/ejbca/core/model/approval/approvalrequests/DummyApprovalRequest.java"/>
       	<include name="org/ejbca/util/cert/CertificateNotBeforeComparator.java"/>
       	<include name="org/ejbca/core/model/ca/publisher/CustomPublisherContainer.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenIssuerDoesntExistsException.java"/>
       	<include name="org/ejbca/core/model/hardtoken/HardTokenIssuerExistsException.java"/>
       	<include name="org/ejbca/core/model/ra/userdatasource/CustomUserDataSourceContainer.java"/>
       	<include name="org/ejbca/core/model/services/workers/CRLUpdateWorker.java"/>
       	<include name="org/ejbca/core/model/services/workers/CertificateExpirationNotifierWorker.java"/>
       	<include name="org/ejbca/core/model/services/workers/PublishQueueProcessWorker.java"/>
       	<include name="org/ejbca/core/model/services/workers/RenewCAWorker.java"/>
       	<include name="org/ejbca/core/model/services/workers/UserPasswordExpireWorker.java"/>
       	<include name="org/ejbca/core/model/services/actions/MailAction.java"/>
       	<include name="org/ejbca/core/model/services/BaseWorker.java"/>
       	<include name="org/ejbca/core/model/services/intervals/PeriodicalInterval.java"/>
       	<include name="org/ejbca/core/model/hardtoken/profiles/EnhancedEIDProfile.java"/>
       	<include name="org/ejbca/core/model/hardtoken/profiles/TurkishEIDProfile.java"/>
       	<include name="org/ejbca/core/model/services/actions/NoAction.java"/>
       	<include name="org/ejbca/util/CombineTime.java"/> <!-- This is only used from AdminGUI, but we probably want to use it more generally -->
       	<include name="org/ejbca/core/model/log/CsvLogExporter.java"/>
		<!-- Dependecies from AdminGUI, EJB, and XMKS -->
		<include name="org/ejbca/config/XkmsConfiguration.java"/>
		<!-- Dependecies from EJBCA WS -->
		<include name="org/ejbca/config/WebServiceConfiguration.java"/>
		<include name="org/ejbca/core/model/approval/ApprovedActionAdmin.java"/>
		<include name="org/ejbca/core/model/approval/approvalrequests/GenerateTokenApprovalRequest.java"/>
		<include name="org/ejbca/core/model/approval/approvalrequests/ViewHardTokenDataApprovalRequest.java"/>
		<include name="org/ejbca/core/protocol/SimpleRequestMessage.java"/>
		<include name="org/ejbca/core/model/hardtoken/types/TurkishEIDHardToken.java"/>
		<include name="org/ejbca/util/DummyPatternLogger.java"/>
		<!-- Dependecies from VA WAR -->
		<include name="org/ejbca/core/protocol/certificatestore/CertStore.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/core/protocol/certificatestore/ICertStore.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/core/protocol/certificatestore/CertificateCacheFactory.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/ui/web/protocol/RFC4387URL.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/core/protocol/crlstore/CRLStore.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/core/protocol/crlstore/ICRLStore.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/core/protocol/crlstore/CRLCacheFactory.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/core/protocol/crlstore/ICRLCache.java"/><!-- VA WAR ONLY! Move! -->
		<include name="org/ejbca/core/protocol/crlstore/CRLCache.java"/><!-- VA WAR ONLY! Move! -->
	</fileset>
	<pathconvert refid="source.fileset.ejbca-common-web" pathsep=" " property="source.fileset.ejbca-common-web.files"><map from="${src.dir}/" to=""/></pathconvert>

	<fileset id="source.fileset.ejbca-ejb" dir="${src.dir}" excludes="${source.fileset.ejbca-util.files} ${source.fileset.ejbca-common-web.files}">
		<!-- Exclude appserver specific code.. -->
        <exclude name="org/ejbca/appserver/**" />
		<!-- Only for External VA.. -->
		<exclude name="org/ejbca/core/protocol/certificatestore/CertStoreStandAlone.java"/>
		<exclude name="org/ejbca/core/protocol/certificatestore/CRLStoreStandAlone.java"/>
        <exclude name="org/ejbca/ui/web/pub/cluster/ValidationAuthorityHealthCheck.java" />
        <exclude name="org/ejbca/core/ejb/ca/store/CertificateStoreOnlyDataSessionBean.java" />
    	<exclude name="org/cesecore/core/ejb/ca/crl/CrlSessionStandAloneBean.java" />
		<!-- Samples should never be included.. -->
        <exclude name="org/ejbca/samples/**/*.java" />
		<!-- Some common classes used by various components.. TODO: If possible, move to the only component using the class.. -->
    	<exclude name="org/ejbca/util/PluginTool.java" />
        <exclude name="org/ejbca/util/PerformanceTest.java" />
		<!-- Tool used to tidy up JavaDoc. -->
        <exclude name="org/ejbca/util/JAXWSDocAndConvTools.java"/>
	</fileset>
	<pathconvert refid="source.fileset.ejbca-ejb" pathsep=" " property="source.fileset.ejbca-ejb.files"><map from="${src.dir}/" to=""/></pathconvert>

	<!-- DEBUG output of what is included where..
	<echo message="source.fileset.ejbca-util.files:       ${source.fileset.ejbca-util.files}"/>
	<echo message="source.fileset.ejbca-common-web.files: ${source.fileset.ejbca-common-web.files}"/>
	<echo message="source.fileset.ejbca-ejb.files:        ${source.fileset.ejbca-ejb.files}"/>
	-->
	
	<!-- Import taget "dependecy-check" -->
	<import file="${this.dir}/build-dependencies.xml"/>

    <target name="clean" depends="dependecy-check-clean" description="Clean up this module">
		<delete dir="${build.dir}" />
		<delete dir="${build-va.dir}" />
		<delete dir="${build-util.dir}" />
		<delete dir="${build-common-web.dir}" />
		<delete dir="${build-test.dir}" />
		<delete file="${mod.ejbca-ejb.lib}" />
		<delete file="${mod.va-ejb.lib}" />
		<delete file="${mod.ejbca-util.lib}" />
		<delete file="${mod.ejbca-common-web.lib}" />
    </target>
	
    <target name="build" description="Build this module" depends="compile-ejbca-ejb">
    	<copy todir="${build.dir}" file="${ejbca.home}/src/internal.properties">
    		<filterchain>
    			<replacestring from="#datasource.jndi-name-prefix=" to="datasource.jndi-name-prefix=${datasource.jndi-name-prefix}"/>
    		</filterchain>
    	</copy>
        <jar destfile="${mod.ejbca-ejb.lib}">
        	<fileset dir="${build.dir}"/>
            <fileset dir="${ejbca.home}">
				<include name="conf/**/*.properties"/>
			</fileset>
            <fileset dir="${ejbca.home}/src/upgrade"/>
        	<!--
            <fileset dir="${tmp}/caTokenClasses">
        		<exclude name="**/META-INF/**"/>
        	</fileset>
        	-->
        	<zipfileset prefix="META-INF" dir="${resources.dir}" includes="weblogic-ejb-jar.xml ibm-ejb-jar-bnd.xml"/>
        </jar>
    	<condition property="generate-stubs" value="true"><equals arg1="websphere" arg2="${appserver.type}"/></condition>
    	<antcall target="generate-stubs"/>
    </target>

	<target name="generate-stubs" if="generate-stubs">
		<!--
		 Some application servers just lets you do remote calls with their client library and then there is WebSphere
		 that forces u to also generate remote stubs in a very medieval way. I hope they have a good reason.
		 
		 This small tool will generate the stubs and put them in the EJB interface file, since this is available wherever
		 remote EJB invocation takes place.
		 -->
		<condition property="generate-stubs-script-extension" value="cmd" else="sh"><os family="windows"/></condition>
		<exec executable="${appserver.home}/bin/createEJBStubs.${generate-stubs-script-extension}">
			<arg line="${mod.ejbca-ejb.lib} -verbose -cp ${mod.ejbca-ejb-interface.lib}:${mod.ejbca-util.lib}:${mod.ejbca-entity.lib} -updatefile ${mod.ejbca-ejb-interface.lib}" />
		</exec>
    </target>

    <target name="build-va" description="Build this module" depends="compile-va-ejb">
    	<copy todir="${build-va.dir}" file="${ejbca.home}/src/internal.properties">
    		<filterchain>
    			<replacestring from="#datasource.jndi-name-prefix=" to="datasource.jndi-name-prefix=${datasource.jndi-name-prefix}"/>
    		</filterchain>
    	</copy>
    	<mkdir dir="${ocsp.hardToken.classes}"/>	<!-- If it doesn't exist.. -->
        <jar destfile="${mod.va-ejb.lib}">
        	<fileset dir="${build-va.dir}" />
            <fileset dir="${ocsp.hardToken.classes}"/>
        	<fileset dir="${ejbca.home}/src" includes="intresources/*.properties"/>
        	<fileset dir="${ejbca.home}/src/java">
        	    <include name="dncomponents.properties"/>
        		<include name="profilemappings.properties"/>
        	</fileset>	
            <fileset dir="${ejbca.home}">
				<include name="conf/**/*.properties"/>
			</fileset>
        </jar>
    </target>

    <target name="build-util" description="Build the ejbca-util JAR" depends="compile-util">
    	<dirname file="${mod.ejbca-util.lib}" property="mod.ejbca-util.lib.dir"/>
    	<mkdir dir="${mod.ejbca-util.lib.dir}" />
    	<jar destfile="${mod.ejbca-util.lib}">
    		<manifest>
				<attribute name="Implementation-Version" value="${app.version}"/>
    		</manifest>
   			<fileset dir="${build-util.dir}" includes="**/*.class"/>
        	<fileset dir="${ejbca.home}/src/java">
        	    <include name="dncomponents.properties"/>
        		<include name="profilemappings.properties"/>
        	</fileset>
    	</jar>
    </target>

    <target name="build-common-web" description="Build the ejbca-common-web JAR" depends="compile-common-web">
    	<dirname file="${mod.ejbca-common-web.lib}" property="mod.ejbca-common-web.lib.dir"/>
    	<mkdir dir="${mod.ejbca-common-web.lib.dir}" />
    	<jar destfile="${mod.ejbca-common-web.lib}">
    		<manifest>
				<attribute name="Implementation-Version" value="${app.version}"/>
    		</manifest>
   			<fileset dir="${build-common-web.dir}" includes="**/*.class"/>
    	</jar>
    </target>
	
    <target name="compile-ejbca-ejb" depends="build-util, build-common-web, ejbca-entity, ejbca-ejb-interface">
    	<mkdir dir="${build.dir}"/>
        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="on" includeantruntime="no" encoding="iso8859-1"
        	includes="${source.fileset.ejbca-ejb.files}" classpathref="compile-ejbca-ejb.classpath"/>
        <copy todir="${build.dir}">
            <fileset dir="${internalresources.base.dir}">
                <include name="intresources/*.properties"/>
            </fileset>	
            <fileset dir="${src.dir}">
                <include name="dncomponents.properties"/>
                <include name="profilemappings.properties"/>
                <include name="certextensions.properties"/>
            </fileset>	
        </copy>
    </target>

    <target name="compile-va-ejb" depends="va-ejb-interface">
    	<mkdir dir="${build-va.dir}"/>
        <javac destdir="${build-va.dir}" debug="on" includeantruntime="no" encoding="iso8859-1" >
            <classpath>
            	<path refid="compile-va-ejb.classpath" />
            </classpath>
        	<!-- EJBs -->
            <include name="org/ejbca/core/ejb/ca/store/CertificateStoreOnlyDataSessionBean.java" />
        	<include name="org/cesecore/core/ejb/ca/crl/CrlSessionStandAloneBean.java" />
			<!-- Classes not available in ejbca-util.jar -->
        	<include name="org/ejbca/core/protocol/certificatestore/CertStoreStandAlone.java"/><!-- Only used in VA WAR! Move source! -->
        	<include name="org/ejbca/core/protocol/crlstore/CRLStoreStandAlone.java"/><!-- Only used in VA WAR! Move source! -->
            <include name="org/ejbca/core/protocol/ocsp/CertificateCacheStandalone.java" /><!-- Only used in VA WAR! Move source! -->
        	<include name="org/ejbca/ui/web/protocol/RFC4387URL.java" /><!-- Only used in VA WAR! Move source! -->
        	<include name="org/ejbca/core/protocol/certificatestore/CertificateCacheFactory.java" /><!-- Only used in VA WAR! Move source! -->
        	<include name="org/ejbca/core/protocol/crlstore/CRLCacheFactory.java"/><!-- Only used in VA WAR! Move source! -->
        	<include name="org/ejbca/core/protocol/crlstore/CRLStoreStandAlone.java"/><!-- Only used in VA WAR! Move source! -->
            <include name="org/ejbca/core/protocol/ws/client/gen/CertificateResponse.java" /><!-- Used in VA WAR! -->
            <include name="org/ejbca/core/protocol/ws/client/gen/EjbcaWS.java" /><!-- Used in VA WAR! -->
            <include name="org/ejbca/core/protocol/ws/client/gen/EjbcaWSService.java" /><!-- Used in VA WAR! -->
            <include name="org/ejbca/core/protocol/ws/client/gen/NameAndId.java" /><!-- Used in VA WAR! -->
            <include name="org/ejbca/core/protocol/ws/client/gen/UserDataVOWS.java" /><!-- Used in VA WAR! -->
            <include name="org/ejbca/core/protocol/ws/client/gen/UserMatch.java" /><!-- Used in VA WAR! -->
            <include name="org/ejbca/core/protocol/ws/common/CertificateHelper.java" /><!-- Used in VA WAR! -->
            <include name="org/ejbca/util/DummyPatternLogger.java"/><!-- Used in VA WAR! -->
        	<include name="org/ejbca/ui/web/pub/cluster/ValidationAuthorityHealthCheck.java" /><!-- Used in healtcheck and VA WAR-->
        	<include name="org/ejbca/ui/web/protocol/IHealtChecker.java" /><!-- Used in healtcheck and VA WAR-->
        	<include name="org/ejbca/core/model/ca/store/CRLInfo.java" /><!-- Used in VA WAR! -->
            <src path="${mod.ejbca-ws-cli.path}/src-gen" />
            <src path="${mod.ejbca-ws.path}/src" />
            <src path="${src.dir}" />
        </javac>
        <copy todir="${build-va.dir}">
            <fileset dir="${internalresources.base.dir}">
                <include name="intresources/*.properties"/>
            </fileset>	
            <fileset dir="${src.dir}">
                <include name="dncomponents.properties"/>
                <include name="profilemappings.properties"/>
                <include name="certextensions.properties"/>
            </fileset>	
        </copy>
    </target>

	<target name="compile-util">
    	<mkdir dir="${build-util.dir}" />
        <javac srcdir="${src.dir}" destdir="${build-util.dir}" debug="on" includeantruntime="no" encoding="iso8859-1" target="${java.target.version}"
        	includes="${source.fileset.ejbca-util.files}" classpathref="compile-util.classpath"/>
    </target>

	<target name="compile-common-web" depends="build-util, ejbca-ejb-interface">
    	<mkdir dir="${build-common-web.dir}" />
        <javac srcdir="${src.dir}" destdir="${build-common-web.dir}" debug="on" includeantruntime="no" encoding="iso8859-1" target="${java.target.version}"
        	includes="${source.fileset.ejbca-common-web.files}" classpathref="compile-common-web.classpath"/>
    </target>

    <target name="compile-tests" depends="dependecy-check, build">
    	<mkdir dir="${build-test.dir}" />
        <javac srcdir="${src-test.dir}" destdir="${build-test.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile-test.classpath"/>
        	</classpath>
    	</javac>
        <copy file="${log4j.test.file}" tofile="${build-test.dir}/log4j.xml" failonerror="true"/>
		<copy todir="${build-test.dir}" failonerror="true">
			<fileset dir="${ejbca.home}/src">
				<include name="intresources/**"/>
			</fileset>
		</copy>
    </target>

	<target name="test" depends="compile-tests" description="Run tests for this module">
    	<antcall target="showtime"/>
    	<property name="reports.dir" location="${reports.base.dir}/test"/>
		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}/html"/>
		<!-- Sequential run of standalone tests.. The old and slow way of doing this.. =)
		<antcall target="test-subprocess">
			<param name="test-subprocess.include-pattern" value="**/*Test.class" />
			<param name="test-subprocess.exclude-pattern" value="" />
		</antcall>
		-->
		<echo message=" ** Running stand-alone tests in parallel chunks. Console output will be a bit scrambled.. **"/>
		<parallel>
			<antcall target="test-subprocess">
				<param name="test-subprocess.include-pattern" value="org/ejbca/core/model/**/*Test.class" />
				<param name="test-subprocess.exclude-pattern" value="" />
			</antcall>
			<antcall target="test-subprocess">
				<param name="test-subprocess.include-pattern" value="org/ejbca/util/**/*Test.class" />
				<param name="test-subprocess.exclude-pattern" value="" />
			</antcall>
			<antcall target="test-subprocess">
				<param name="test-subprocess.include-pattern" value="**/*Test.class" />
				<param name="test-subprocess.exclude-pattern" value="org/ejbca/core/model/**/*Test.class org/ejbca/util/**/*Test.class" />
			</antcall>
		</parallel>
		<antcall target="createreport"/>
    	<antcall target="showtime"/>
    </target>

	<target name="test-subprocess">
		<junit printsummary="yes" haltonfailure="no" dir="${this.dir}">
			<classpath>
        		<path refid="test.classpath"/>
        		<path refid="lib.clover.classpath"/>
			</classpath>
			<formatter type="xml" />
			<batchtest fork="yes" todir="${reports.dir}">
				<fileset dir="${build-test.dir}" includes="${test-subprocess.include-pattern}" excludes="${test-subprocess.exclude-pattern}"/>
			</batchtest>
		</junit>
	</target>
	
	<target name="runone" depends="compile-tests">
		<fail message="'test.runone' is not set. Example -Dtest.runone=ApprovalExecutorUtilTest" unless="test.runone" />
    	<property name="reports.dir" location="${reports.base.dir}/runone"/>
		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}/html"/>
		<junit printsummary="yes" haltonfailure="no" >
			<classpath>
        		<path refid="test.classpath"/>
			</classpath>
			<formatter type="xml" />
			<batchtest fork="yes" todir="${reports.dir}">
				<fileset dir="${build-test.dir}">
					<include name="**/${test.runone}.class" />
				</fileset>
			</batchtest>
		</junit>
		<antcall target="createreport"/>
	</target>
</project>
