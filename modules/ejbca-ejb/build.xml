<?xml version="1.0" encoding="UTF-8"?>
<project name="ejbca-ejb" default="build">
    <description>
            The EJBCA EJB component.
    	
    		The EJBCA util library is also built from this source.
    </description>

	<dirname property="this.dir" file="${ant.file.ejbca-ejb}"/>
	<import file="${this.dir}/../build.xml"/>
	
	<property name="build.dir" location="${this.dir}/build"/>
	<property name="build-util.dir" location="${this.dir}/build-util"/>
	<property name="build-temp.dir" location="${this.dir}/build-temp"/>
	<property name="build-test.dir" location="${this.dir}/build-test"/>
	<property name="src.dir" location="${ejbca.home}/src/java"/>
	<property name="src-temp.dir" location="${this.dir}/src-temp"/>
	<property name="src-test.dir" location="${this.dir}/src-test"/>
	<property name="reports.base.dir" location="${this.dir}/build-test/reports/"/>

	<path id="compile.classpath">
		<path refid="compile-util.classpath"/>
	</path>
	
	<path id="compile-util.classpath">
		<path refid="lib.cert-cvc.classpath"/>
		<path refid="lib.bouncycastle.classpath"/>
		<path refid="lib.log4j.classpath"/>
		<path refid="lib.commons-lang.classpath"/>
		<path refid="lib.commons-config.classpath"/>
		<path refid="lib.commons-collections.classpath"/>
		<path refid="lib.commons-logging.classpath"/>
		<path refid="lib.servlet.classpath"/>
		<path refid="lib.jline.classpath"/>
		<path refid="lib.ldap.classpath"/>
		<path refid="lib.mail.classpath"/>
		<path refid="lib.batik.classpath"/>
		<path refid="lib.xmlsec.classpath"/>
		<path refid="lib.jee.classpath"/>
	</path>

	<path id="test.classpath">
		<path location="${build-test.dir}" />
		<path location="${mod.ejbca-ejb.lib}" />
		<path refid="compile.classpath"/>
		<path refid="lib.junit.classpath"/>
	</path>

    <target name="build" description="Build this module" depends="dependecy-check, ejbca-ejb">
    	<!-- This module is still JARed in the old build system -->
    </target>

    <target name="build-util" description="Build the ejbca-util JAR" depends="compile-util">
    	<dirname file="${mod.ejbca-util.lib}" property="mod.ejbca-util.lib.dir"/>
    	<mkdir dir="${mod.ejbca-util.lib.dir}" />
    	<jar destfile="${mod.ejbca-util.lib}">
   			<fileset dir="${build-util.dir}" includes="**/*.class"/>
        	<fileset dir="${ejbca.home}/src/java">
        	    <include name="dncomponents.properties"/>
        		<include name="profilemappings.properties"/>
        	</fileset>
    	</jar>
    </target>

    <target name="clean" description="Clean up this module">
		<delete dir="${build.dir}" />
		<delete dir="${build-util.dir}" />
		<delete dir="${src-temp.dir}" />
		<delete dir="${build-temp.dir}" />
		<delete dir="${build-test.dir}" />
		<delete file="${mod.ejbca-ejb.lib}" />
		<delete file="${mod.ejbca-util.lib}" />
    </target>
	
    <target name="compile">
    	<fail message="This component currently only holds the tests that depends on classes from the EJB component!"/>
    </target>

    <target name="dependecy-check" depends="ejbca-ejb-interfaces-xdoclet" description="Perform a dependency check on the different EJBCA core components">
    	<!--
    		To enforce proper dependencies between different core components of the EJBCA core should be able to
    		compile each component with only the current components dependecies in the classpath. To make sure
    		this happens we need to isolate the source files first.
    		
    		The code below are mainly a temporary help to be able to devide the components into new packages
    		more easily. Ideally each include should only be "org/ejbca/<component>/**/*.java" and each check
    		could be placed in proper reusable sub-targets.
    	-->
    	<mkdir dir="${src-temp.dir}"/>
    	<mkdir dir="${build-temp.dir}"/>
    	<!-- Basic configuration, utils and constants component -->
    	<echo message=" ** Validating component: Basics **"/>
    	<mkdir dir="${src-temp.dir}/common"/>
    	<mkdir dir="${build-temp.dir}/common"/>
    	<copy todir="${src-temp.dir}/common">
    		<fileset dir="${ejbca.home}/tmp/bin/gensrc">
    			<include name="org/ejbca/core/ejb/PropertyEntityPK.java"/>
    		</fileset>
    		<fileset dir="${src.dir}">
    			<include name="org/ejbca/config/ConfigurationHolder.java"/>
    			<include name="org/ejbca/config/EjbcaConfiguration.java"/>
    			<include name="org/ejbca/util/CryptoProviderTools.java"/>
    			<include name="org/ejbca/util/GUIDGenerator.java"/>
    			<include name="org/ejbca/util/JDBCUtil.java"/>
    			<include name="org/ejbca/util/StringTools.java"/>
    			<include name="org/ejbca/util/FileTools.java"/>
    			<include name="org/ejbca/util/Base64.java"/>
    			<include name="org/ejbca/core/ejb/*.java"/>
    			<!-- Dependecies from Protect that are pretty general.. -->
    			<include name="org/ejbca/core/model/InternalResources.java"/>
    			
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/common" destdir="${build-temp.dir}/common" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<pathelement location="${build-temp.dir}/config"/>
        		<path refid="compile.classpath"/>
        	</classpath>
        </javac>
    	<!-- Protect component -->
    	<echo message=" ** Validating component: Protect **"/>
    	<mkdir dir="${src-temp.dir}/protect"/>
    	<mkdir dir="${build-temp.dir}/protect"/>
    	<copy todir="${src-temp.dir}/protect">
    		<fileset dir="${ejbca.home}/tmp/bin/gensrc">
    			<include name="org/ejbca/core/ejb/protect/**/*DataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/protect/**/*DataLocal.java"/>
    			<include name="org/ejbca/core/ejb/protect/**/TableProtectSessionLocal.java"/>
    			<include name="org/ejbca/core/ejb/protect/**/TableProtectSessionLocalHome.java"/>
    		</fileset>
    		<fileset dir="${src.dir}">
    			<include name="org/ejbca/core/ejb/protect/**/*.java"/>
    			<include name="org/ejbca/core/model/protect/**/*.java"/>
    			<include name="org/ejbca/config/ProtectConfiguration.java"/>
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/protect" destdir="${build-temp.dir}/protect" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<pathelement location="${build-temp.dir}/common"/>
        	</classpath>
        </javac>
    	<!-- AdminObjects component -->
    	<echo message=" ** Validating component: AdminObjects **"/>
    	<mkdir dir="${src-temp.dir}/admins"/>
    	<mkdir dir="${build-temp.dir}/admins"/>
    	<copy todir="${src-temp.dir}/admins">
    		<fileset dir="${src.dir}">
    			<include name="org/ejbca/core/model/log/Admin.java"/>
    			<include name="org/ejbca/core/model/authorization/AdminEntity.java"/>
    			<include name="org/ejbca/core/model/authorization/AdminInformation.java"/>
    			<include name="org/ejbca/util/dn/DNFieldExtractor.java"/>
    			<include name="org/ejbca/util/dn/DnComponents.java"/>
    			<include name="org/ejbca/util/CertTools.java"/>
    			<include name="org/ejbca/core/model/ca/crl/RevokedCertInfo.java"/>
    			<include name="org/ejbca/core/model/ca/catoken/CATokenConstants.java"/>
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/admins" destdir="${build-temp.dir}/admins" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<pathelement location="${build-temp.dir}/common"/>
        	</classpath>
        </javac>
    	<!-- Logging component -->
    	<echo message=" ** Validating component: Logging (except ProtectedLog, CvsExporter) **"/>
    	<mkdir dir="${src-temp.dir}/logging"/>
    	<mkdir dir="${build-temp.dir}/logging"/>
    	<copy todir="${src-temp.dir}/logging">
    		<fileset dir="${ejbca.home}/tmp/bin/gensrc">
    			<include name="org/ejbca/core/ejb/log/**/ILogSessionLocal.java"/>
    			<include name="org/ejbca/core/ejb/log/**/ILogSessionLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/log/**/ILogSessionLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/log/**/LogEntryDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/log/**/LogEntryDataLocal.java"/>
    			<include name="org/ejbca/core/ejb/log/**/LogConfigurationDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/log/**/LogConfigurationDataLocal.java"/>
    		</fileset>
    		<fileset dir="${src.dir}">
    			<include name="org/ejbca/core/ejb/log/**/*.java"/>
    			<include name="org/ejbca/core/model/log/**/*.java"/>
    			<include name="org/ejbca/config/LogConfiguration.java"/>
    			<include name="org/ejbca/config/OldLogConfiguration.java"/>
    			<include name="org/ejbca/util/query/**/*.java"/>
    			<include name="org/ejbca/util/ObjectCache.java"/>
    			<exclude name="org/ejbca/core/ejb/log/**/ProtectedLog*.java"/>
    			<exclude name="org/ejbca/core/model/log/**/ProtectedLog*.java"/>
    			<exclude name="org/ejbca/core/model/log/**/IProtectedLog*.java"/>
    			<exclude name="org/ejbca/core/model/log/CsvLogExporter.java"/>
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/logging" destdir="${build-temp.dir}/logging" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<pathelement location="${build-temp.dir}/common"/>
        		<pathelement location="${build-temp.dir}/protect"/>
        		<pathelement location="${build-temp.dir}/admins"/>
        	</classpath>
        </javac>
    	<!-- Authorization component -->
    	<echo message=" ** Validating component: Authorization **"/>
    	<mkdir dir="${src-temp.dir}/authorization"/>
    	<mkdir dir="${build-temp.dir}/authorization"/>
    	<copy todir="${src-temp.dir}/authorization">
    		<fileset dir="${ejbca.home}/tmp/bin/gensrc">
    			<include name="org/ejbca/core/ejb/authorization/**/AdminEntityDataLocal.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/AdminEntityDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/AccessRulesDataLocal.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/AccessRulesDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/AdminGroupDataLocal.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/AdminGroupDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/AuthorizationTreeUpdateDataLocal.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/AuthorizationTreeUpdateDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/IAuthorizationSessionLocal.java"/>
    			<include name="org/ejbca/core/ejb/authorization/**/IAuthorizationSessionLocalHome.java"/>
    		</fileset>
    		<fileset dir="${src.dir}">
    			<include name="org/ejbca/core/ejb/authorization/**/*.java"/>
    			<include name="org/ejbca/core/model/authorization/**/*.java"/>
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/authorization" destdir="${build-temp.dir}/authorization" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<pathelement location="${build-temp.dir}/common"/>
        		<pathelement location="${build-temp.dir}/protect"/>
        		<pathelement location="${build-temp.dir}/admins"/>
        		<pathelement location="${build-temp.dir}/logging"/>
        	</classpath>
        </javac>
    	<!-- Notification component -->
    	<echo message=" ** Validating component: Notification Base 	**"/>
    	<mkdir dir="${src-temp.dir}/notification"/>
    	<mkdir dir="${build-temp.dir}/notification"/>
    	<copy todir="${src-temp.dir}/notification">
    		<fileset dir="${src.dir}">
    			<!-- Include the Mail utility and configuration as a subcomponent of Notification -->
    			<include name="org/ejbca/config/MailConfiguration.java"/>
    			<include name="org/ejbca/util/mail/*.java"/>
    			<!-- Include the notification base components -->
				<include name="org/ejbca/util/NotificationParamGen.java"/>
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/notification" destdir="${build-temp.dir}/notification" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<pathelement location="${build-temp.dir}/common"/>
        		<pathelement location="${build-temp.dir}/protect"/>
        		<pathelement location="${build-temp.dir}/admins"/>
        		<pathelement location="${build-temp.dir}/logging"/>
        	</classpath>
        </javac>
    	<!-- Approval component -->
    	<echo message=" ** Validating component: Approval Base (still includes GlobalConfiguration..) **"/>
    	<mkdir dir="${src-temp.dir}/approval"/>
    	<mkdir dir="${build-temp.dir}/approval"/>
    	<copy todir="${src-temp.dir}/approval">
    		<fileset dir="${ejbca.home}/tmp/bin/gensrc">
    			<include name="org/ejbca/core/ejb/approval/ApprovalDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/approval/ApprovalDataLocal.java"/>
    			<include name="org/ejbca/core/ejb/approval/IApprovalSessionLocal.java"/>
    			<include name="org/ejbca/core/ejb/approval/IApprovalSessionLocalHome.java"/>
    		</fileset>
    		<fileset dir="${src.dir}">
    			<include name="org/ejbca/core/ErrorCode.java"/>
    			<include name="org/ejbca/core/ejb/approval/**/*.java"/>
    			<include name="org/ejbca/core/model/approval/**/*.java"/>
    	    	<!-- GlobalConfiguration is more of RA/AdminGUI component, but is hard to get rid of w/o database changes.. -->
    			<include name="org/ejbca/core/model/ra/raadmin/GlobalConfiguration.java"/>
    			<include name="org/ejbca/config/InternalConfiguration.java"/>
    			<include name="org/ejbca/config/WebConfiguration.java"/>
    			<include name="org/ejbca/core/model/UpgradeableDataHashMap.java"/>
    			<include name="org/ejbca/core/model/IUpgradeableData.java"/>
    	    	<!-- SecConst should proabaly be devided into several constants classes.. -->
    			<include name="org/ejbca/core/model/SecConst.java"/>
    	    	<!-- RA approval requests -->
    			<exclude name="org/ejbca/core/model/approval/approvalrequests/EditEndEntityApprovalRequest.java"/>
    			<exclude name="org/ejbca/core/model/approval/approvalrequests/AddEndEntityApprovalRequest.java"/>
    			<exclude name="org/ejbca/core/model/approval/ApprovalRequestHelper.java"/>
    			<exclude name="org/ejbca/core/model/approval/approvalrequests/ChangeStatusEndEntityApprovalRequest.java"/>
    			<exclude name="org/ejbca/core/model/approval/approvalrequests/RevocationApprovalRequest.java"/>
    	    	<!-- CA approval requests -->
    			<exclude name="org/ejbca/core/model/approval/approvalrequests/ActivateCATokenApprovalRequest.java"/>
    	    	<!-- Key Recovery approval requests -->
    			<exclude name="org/ejbca/core/model/approval/approvalrequests/KeyRecoveryApprovalRequest.java"/>
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/approval" destdir="${build-temp.dir}/approval" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<pathelement location="${build-temp.dir}/common"/>
        		<!--<pathelement location="${build-temp.dir}/protect"/> "Legal" dependency, but not really used -->
        		<pathelement location="${build-temp.dir}/admins"/>
        		<pathelement location="${build-temp.dir}/logging"/>
        		<pathelement location="${build-temp.dir}/authorization"/>
        		<pathelement location="${build-temp.dir}/notification"/>
        	</classpath>
        </javac>
    	<!-- Key Recovery component - Is still dependend on the CA component... -->
    	<!--
    	<echo message=" ** Validating component: Key Recovery **"/>
    	<mkdir dir="${src-temp.dir}/keyrecovery"/>
    	<mkdir dir="${build-temp.dir}/keyrecovery"/>
    	<copy todir="${src-temp.dir}/keyrecovery">
    		<fileset dir="${ejbca.home}/tmp/bin/gensrc">
    			<include name="org/ejbca/core/ejb/keyrecovery/KeyRecoveryDataLocalHome.java"/>
    			<include name="org/ejbca/core/ejb/keyrecovery/KeyRecoveryDataLocal.java"/>
    			<include name="org/ejbca/core/ejb/keyrecovery/KeyRecoveryDataPK.java"/>
    		</fileset>
    		<fileset dir="${src.dir}">
    			<include name="org/ejbca/core/ejb/keyrecovery/**/*.java"/>
    			<include name="org/ejbca/core/model/keyrecovery/**/*.java"/>
    		</fileset>
    	</copy>
        <javac srcdir="${src-temp.dir}/keyrecovery" destdir="${build-temp.dir}/keyrecovery" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        		<pathelement location="${build-temp.dir}/common"/>
        		<pathelement location="${build-temp.dir}/protect"/>
        		<pathelement location="${build-temp.dir}/admins"/>
        		<pathelement location="${build-temp.dir}/logging"/>
        		<pathelement location="${build-temp.dir}/authorization"/>
        		<pathelement location="${build-temp.dir}/notification"/>
        		<pathelement location="${build-temp.dir}/approval"/>
        	</classpath>
        </javac>
        -->
    </target>

    <target name="compile-util">
    	<mkdir dir="${build-util.dir}" />
        <javac srcdir="${src.dir}" destdir="${build-util.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile-util.classpath"/>
        	</classpath>
        	<!-- From EJBCA WS common lib -->
           	<include name="org/ejbca/core/model/SecConst.java"/>
        	<include name="org/ejbca/core/model/approval/ApprovalRequestExecutionException.java"/>
        	<include name="org/ejbca/core/model/approval/ApprovalRequestExpiredException.java"/>
           	<include name="org/ejbca/core/model/approval/WaitingForApprovalException.java"/>
           	<include name="org/ejbca/core/model/authorization/AuthorizationDeniedException.java"/>
           	<include name="org/ejbca/core/model/ca/SignRequestException.java"/>
           	<include name="org/ejbca/core/model/ca/caadmin/CADoesntExistsException.java"/>
           	<include name="org/ejbca/core/model/ca/publisher/PublisherException.java"/>
           	<include name="org/ejbca/core/model/hardtoken/HardTokenDoesntExistsException.java"/>
           	<include name="org/ejbca/core/model/hardtoken/HardTokenExistsException.java"/>
           	<include name="org/ejbca/core/model/ra/AlreadyRevokedException.java"/>
           	<include name="org/ejbca/core/model/ra/NotFoundException.java"/>
           	<include name="org/ejbca/core/model/ra/UserDataConstants.java"/>
           	<include name="org/ejbca/core/model/ra/raadmin/UserDoesntFullfillEndEntityProfile.java"/>
           	<include name="org/ejbca/core/model/ra/userdatasource/MultipleMatchException.java"/>
           	<include name="org/ejbca/core/model/ra/userdatasource/UserDataSourceException.java"/>
           	<include name="org/ejbca/core/model/hardtoken/HardTokenConstants.java"/>
        	<include name="org/ejbca/util/CertTools.java"/>
           	<include name="org/ejbca/util/query/IllegalQueryException.java"/>
           	<include name="org/ejbca/util/query/BasicMatch.java"/>
           	<include name="org/ejbca/util/query/UserMatch.java"/>
        	<!-- From EJBCA WS CLI (including some of the classes above) -->
           	<include name="org/ejbca/ui/cli/ErrorAdminCommandException.java"/>
           	<include name="org/ejbca/ui/cli/IAdminCommand.java"/>
           	<include name="org/ejbca/ui/cli/IllegalAdminCommandException.java"/>
           	<include name="org/ejbca/util/keystore/P11Slot.java"/>
           	<include name="org/ejbca/util/provider/TLSProvider.java"/>
           	<include name="org/ejbca/util/PerformanceTest.java"/>
           	<include name="org/ejbca/util/RequestMessageUtils.java"/>
        	<!-- From EJBCA XKMS CLI (including some of the classes above) -->
           	<include name="org/ejbca/util/keystore/P12toPEM.java"/>
        	<!-- From EJBCA EJB interfaces (including some of the classes above) -->
           	<include name="org/ejbca/core/model/log/Admin.java"/>
           	<include name="org/ejbca/core/model/approval/AdminAlreadyApprovedRequestException.java"/>
           	<include name="org/ejbca/core/model/approval/ApprovalDataVO.java"/>
           	<include name="org/ejbca/core/model/approval/Approval.java"/>
           	<include name="org/ejbca/util/query/Query.java"/>
           	<include name="org/ejbca/core/model/authorization/AdminGroup.java"/>
           	<include name="org/ejbca/core/model/authorization/AdminGroupExistsException.java"/>
           	<include name="org/ejbca/core/model/authorization/AuthenticationFailedException.java"/>
           	<include name="org/ejbca/core/model/ca/AuthStatusException.java"/>
           	<include name="org/ejbca/core/model/ca/AuthLoginException.java"/>
           	<include name="org/ejbca/core/model/ca/caadmin/CAExistsException.java"/>
           	<include name="org/ejbca/core/model/ca/caadmin/CAInfo.java"/>
           	<include name="org/ejbca/core/model/ca/caadmin/IllegalKeyStoreException.java"/>
           	<include name="org/ejbca/core/model/ca/publisher/PublisherQueueVolatileData.java"/>
           	<include name="org/ejbca/core/model/ra/ExtendedInformation.java"/>
           	<include name="org/ejbca/core/model/ca/publisher/PublisherConnectionException.java"/>
           	<include name="org/ejbca/core/model/ca/publisher/BasePublisher.java"/>
           	<include name="org/ejbca/core/model/ca/publisher/PublisherExistsException.java"/>
           	<include name="org/ejbca/core/model/ca/IllegalKeyException.java"/>
           	<include name="org/ejbca/core/model/ca/SignRequestSignatureException.java"/>
           	<include name="org/ejbca/core/model/ca/extendedcaservices/ExtendedCAServiceRequest.java"/>
           	<include name="org/ejbca/core/model/ca/extendedcaservices/ExtendedCAServiceResponse.java"/>
           	<include name="org/ejbca/core/ejb/ca/store/CertificateStatus.java"/>
           	<include name="org/ejbca/core/model/ca/store/CertificateInfo.java"/>
           	<include name="org/ejbca/core/model/ca/store/CRLInfo.java"/>
           	<include name="org/ejbca/core/model/ca/store/CertReqHistory.java"/>
           	<include name="org/ejbca/core/model/ca/certificateprofiles/CertificateProfileExistsException.java"/>
           	<include name="org/ejbca/core/model/ca/certificateprofiles/CertificateProfile.java"/>
           	<include name="org/ejbca/core/model/hardtoken/UnavailableTokenException.java"/>
           	<include name="org/ejbca/core/model/hardtoken/profiles/HardTokenProfile.java"/>
           	<include name="org/ejbca/core/model/hardtoken/HardTokenProfileExistsException.java"/>
           	<include name="org/ejbca/core/model/hardtoken/HardTokenIssuer.java"/>
           	<include name="org/ejbca/core/model/hardtoken/HardTokenIssuerData.java"/>
           	<include name="org/ejbca/core/model/hardtoken/types/HardToken.java"/>
           	<include name="org/ejbca/core/model/hardtoken/HardTokenData.java"/>
           	<include name="org/ejbca/core/model/keyrecovery/KeyRecoveryData.java"/>
           	<include name="org/ejbca/core/model/log/ILogExporter.java"/>
           	<include name="org/ejbca/core/model/log/LogConfiguration.java"/>
           	<include name="org/ejbca/core/model/log/ILogDevice.java"/>
           	<include name="org/ejbca/core/model/log/IProtectedLogToken.java"/>
           	<include name="org/ejbca/core/model/log/ProtectedLogExportRow.java"/>
           	<include name="org/ejbca/core/model/log/ProtectedLogEventRow.java"/>
           	<include name="org/ejbca/core/model/log/ProtectedLogEventIdentifier.java"/>
           	<include name="org/ejbca/core/model/log/IProtectedLogExportHandler.java"/>
           	<include name="org/ejbca/core/model/protect/TableVerifyResult.java"/>
           	<include name="org/ejbca/core/model/ra/raadmin/AdminPreference.java"/>
           	<include name="org/ejbca/core/model/ra/raadmin/EndEntityProfileExistsException.java"/>
           	<include name="org/ejbca/core/model/ra/userdatasource/BaseUserDataSource.java"/>
           	<include name="org/ejbca/core/model/ra/userdatasource/UserDataSourceExistsException.java"/>
           	<include name="org/ejbca/core/model/services/ServiceExistsException.java"/>
           	<include name="org/ejbca/core/model/services/ServiceConfiguration.java"/>
        	<!-- From EJBCA EJB CLI (including some of the classes above) -->
           	<include name="org/ejbca/core/ejb/ServiceLocator.java"/>
           	<include name="org/ejbca/core/protocol/X509ResponseMessage.java"/>
           	<include name="org/ejbca/util/PluginTool.java"/>
           	<include name="org/ejbca/util/PrinterManager.java"/>
           	<include name="org/ejbca/core/model/authorization/AccessRulesConstants.java"/>
           	<include name="org/ejbca/core/model/ra/UserAdminConstants.java"/>
           	<include name="org/ejbca/util/CliTools.java"/>
           	<include name="org/ejbca/core/model/ca/caadmin/X509CAInfo.java"/>
           	<include name="org/ejbca/core/model/hardtoken/types/EnhancedEIDHardToken.java"/>
           	<include name="org/ejbca/core/model/hardtoken/types/SwedishEIDHardToken.java"/>
           	<include name="org/ejbca/core/model/log/ProtectedLogConstants.java"/>
           	<include name="org/ejbca/core/model/hardtoken/profiles/IPINEnvelopeSettings.java"/>
           	<include name="org/ejbca/core/model/hardtoken/profiles/SwedishEIDProfile.java"/>
        	<!-- From EJBCA External SCEP RA (including some of the classes above) -->
           	<include name="org/ejbca/core/protocol/scep/ScepRequestMessage.java"/>
           	<include name="org/ejbca/core/protocol/scep/ScepResponseMessage.java"/>
    	</javac>
    </target>

    <target name="compile-tests" depends="build">
    	<mkdir dir="${build-test.dir}" />
        <javac srcdir="${src-test.dir}" destdir="${build-test.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
				<path location="${mod.ejbca-ejb.lib}" />
        		<path refid="compile.classpath"/>
        		<path refid="lib.junit.classpath"/>
        	</classpath>
    	</javac>
        <copy file="${this.dir}/log4j.xml" todir="${build-test.dir}" failonerror="true"/>
		<copy todir="${build-test.dir}" failonerror="true">
			<fileset dir="${ejbca.home}/src">
				<include name="intresources/**"/>
			</fileset>
		</copy>
    </target>

	<target name="test" depends="compile-tests" description="Run tests for this module">
    	<antcall target="showtime"/>
    	<property name="reports.dir" location="${reports.base.dir}/test"/>
		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}/html"/>
		<junit printsummary="yes" haltonfailure="no" dir="${this.dir}">
			<classpath>
        		<path refid="test.classpath"/>
        		<path refid="lib.clover.classpath"/>
			</classpath>
			<formatter type="xml" />
			<batchtest fork="yes" todir="${reports.dir}">
				<fileset dir="${build-test.dir}" includes="**/*.class">
					<exclude name="org/ejbca/core/model/approval/ApprovalJunitHelper*.class"/>
					<exclude name="org/ejbca/core/model/InternalResourcesTestClass.class"/>
					<exclude name="org/ejbca/core/model/util/AlgorithmToolsHelper*.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/CacheExceptionHandler.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/CacheTester.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/OcspUtilMockups*.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/OcspUtilMockups*.class"/>
				</fileset>
			</batchtest>
		</junit>
		<antcall target="createreport"/>
    	<antcall target="showtime"/>
    </target>
	
	<target name="runone" depends="compile-tests">
		<fail message="'test.runone' is not set. Example -Dtest.runone=TestApprovalExecutorUtil" unless="test.runone" />
    	<property name="reports.dir" location="${reports.base.dir}/runone"/>
		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}/html"/>
		<junit printsummary="yes" haltonfailure="no" >
			<classpath>
        		<path refid="test.classpath"/>
			</classpath>
			<formatter type="xml" />
			<batchtest fork="yes" todir="${reports.dir}">
				<fileset dir="${build-test.dir}">
					<include name="**/${test.runone}.class" />
				</fileset>
			</batchtest>
		</junit>
		<antcall target="createreport"/>
	</target>
</project>
